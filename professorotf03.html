<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard do Aluno - Dark Mode</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>

    <style>
        /* [Estilos CSS - Mantido como o seu original] */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 20px; background-color: #000000; color: #f0f0f0; }
        nav { text-align: right; margin-bottom: 10px; }
        nav a { color: #ff8c00; text-decoration: none; font-size: 0.9em; }
        
        /* HEADER */
        .header-content { display: flex; align-items: center; justify-content: center; flex-wrap: wrap; margin-bottom: 30px; gap: 20px; text-align: center; }
        .header-content img { max-width: 80px; height: auto; border-radius: 10px; }
        .header-content h1 { color: #ff8c00; margin: 0; font-size: 2.2em; line-height: 1.2; }
        
        /* LAYOUT RESPONSIVO */
        .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 20px; width: 100%; justify-content: center; grid-template-columns: 1fr; }
        @media (min-width: 768px) { .container { grid-template-columns: 1fr 1fr; } #chart-card { grid-column: 1 / 3; order: 1; } }
        @media (min-width: 1024px) { .container { grid-template-columns: 1fr 1fr 1fr; } #chart-card { grid-column: auto; order: initial; } }

        /* CARDS */
        .card { background-color: rgba(255, 255, 255, 0.1); padding: 25px; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.2); }
        #medidas-card { order: 2; }

        /* FORMUL√ÅRIOS E INPUTS */
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .input-group label { width: 95px; flex-shrink: 0; font-size: 0.9em; color: #ccc; }
        .input-group input, select { flex-grow: 1; padding: 8px; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); color: #f0f0f0; border-radius: 4px; width: 100%; box-sizing: border-box; }
        
        select { margin-bottom: 15px; appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="%23ff9933" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>'); background-repeat: no-repeat; background-position: right 8px center; padding-right: 30px; }
        select option { background-color: #1a1a1a; }

        /* TITULOS */
        h2 { color: #ff9933; margin-top: 0; margin-bottom: 15px; }

        /* CONTAINER DO GR√ÅFICO */
        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 20px; }

        /* LISTA DE TREINO */
        .exercicio-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; margin-bottom: 10px; background-color: rgba(255, 255, 255, 0.05); border-radius: 8px; transition: background-color 0.3s; }
        .exercicio-item:hover { background-color: rgba(255, 255, 255, 0.1); }
        .exercicio-info strong { font-size: 1.1em; display: block; margin-bottom: 5px; }
        .checkbox-container input[type="checkbox"] { transform: scale(1.3); cursor: pointer; }
        .concluido { background-color: #387038; opacity: 0.7; text-decoration: line-through; color: #a0a0a0; }

        /* TABELA PRESEN√áA */
        .presenca-table { width: 100%; border-collapse: collapse; text-align: center; }
        .presenca-table th, .presenca-table td { border: 1px solid rgba(255, 255, 255, 0.2); padding: 8px; cursor: pointer; }
        .presenca-table th { background-color: #ff8c00; color: white; }
        .presente { background-color: #5cb85c !important; color: white; }

        /* BOT√ïES */
        button { padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-weight: bold; transition: 0.3s; }
        .btn-primary { background-color: #ffc107; color: #333; }
        .btn-primary:hover { background-color: #e0a800; }
        .reset-btn { margin-top: 15px; background-color: #dc3545; color: white; }
        .reset-btn:hover { background-color: #c9302c; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #0d0d0d; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; border: 2px solid #ff8c00; }
        .modal-content img { max-width: 100px; margin-bottom: 20px; }
        #botaoSalvarNome { background-color: #ff8c00; color: #000; margin-top: 10px; }
    </style>
</head>

<body onload="obterNomeAluno()">

    <nav>
        <a href="professor.html">Acessar a P√°gina do Professor</a>
    </nav>

    <div id="modal-nome" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <img src="logotipo.png" alt="Logo PTF3" onerror="this.style.display='none'">
            <h3>Bem-vindo(a)!</h3>
            <p>Por favor, insira seu nome:</p>
            <input type="text" id="nomeModalInput" placeholder="Ex: Maria da Silva" style="width: 100%; padding: 10px; margin-bottom: 10px;">
            <button id="botaoSalvarNome" onclick="salvarNomeModal()">Entrar</button>
        </div>
    </div>

    <div class="header-content">
        <img src="logotipo.png" alt="Logo PTF3" onerror="this.style.display='none'">
        <h1 id="main-title">Seja bem-vindo ao seu Espa√ßo.</h1>
    </div>

    <div class="container">

        <div id="chart-card" class="card">
            <h2>üìà Progress√£o de Carga</h2>
            <label for="seletorExercicio">Visualizar Exerc√≠cio:</label>
            <select id="seletorExercicio" onchange="inicializarGrafico()">
                <option value="AgachamentoLivre">Agachamento Livre</option>
                <option value="SupinoReto">Supino Reto</option>
                <option value="PuxadaFrontal">Puxada Frontal</option>
            </select>
            
            <div class="chart-container">
                <canvas id="pesoChart"></canvas>
            </div>

            <div class="input-group">
                <input type="number" id="pesoInput" placeholder="Carga (kg)" step="0.5">
                <button class="btn-primary" onclick="adicionarPeso()">Registrar Carga</button>
            </div>
            <button class="reset-btn" onclick="resetarDados('cargas')">Resetar Hist√≥rico</button>
        </div>

        <div id="medidas-card" class="card">
            <h2>üìè Registro de Medidas</h2>
            <p style="margin-bottom: 15px; font-size: 0.9em; color: #ccc;">Acompanhe sua evolu√ß√£o.</p>

            <div class="input-group"><label>Peso (kg)</label><input type="number" id="pesoCorporalInput" placeholder="Ex: 75.5" step="0.1"></div>
            <div class="input-group"><label>Cintura</label><input type="number" id="cinturaInput" placeholder="cm" step="1"></div>
            <div class="input-group"><label>Bra√ßo D.</label><input type="number" id="bracoInput" placeholder="cm" step="0.5"></div>
            <div class="input-group"><label>T√≥rax</label><input type="number" id="toraxInput" placeholder="cm" step="1"></div>
            <div class="input-group"><label>Abd√¥men</label><input type="number" id="abdomenInput" placeholder="cm" step="1"></div>
            <div class="input-group"><label>Coxa D.</label><input type="number" id="coxaInput" placeholder="cm" step="0.5"></div>
            <div class="input-group"><label>Panturrilha</label><input type="number" id="panturrilhaInput" placeholder="cm" step="0.5"></div>
            <div class="input-group"><label>Antebra√ßo</label><input type="number" id="antebracoInput" placeholder="cm" step="0.5"></div>

            <button class="btn-primary" onclick="registrarMedidas()">Registrar Medidas</button>

            <h3 style="margin-top: 15px; color: #ff9933;">√öltimos Registros</h3>
            <div id="ultimasMedidas" style="font-size: 0.9em; color: #ccc;">Nenhum registro encontrado.</div>
            <button class="reset-btn" onclick="resetarDados('medidas')">Resetar Medidas</button>
        </div>

        <div id="treino-card" class="card">
            <h2>üèãÔ∏è Treino de For√ßa</h2>

            <label for="seletorTreino">Selecionar Dia:</label>
            <select id="seletorTreino" onchange="alternarTreino()">
                <option value="Dia A">Dia A - Peito/Ombro/Tr√≠ceps</option>
                <option value="Dia B">Dia B - Costas/B√≠ceps</option>
                <option value="Dia C">Dia C - Pernas</option>
            </select>
            <hr style="border-color: rgba(255, 255, 255, 0.2);">

            <p><strong>Aluno:</strong> <span id="nome-aluno" style="color:#ff8c00">...</span> | <strong>Data:</strong> <span id="data-atual"></span></p>

            <div id="treino-Dia A" class="lista-treino-dia">
                <h3>Dia A: Peito, Ombros e Tr√≠ceps</h3>
                <ul id="lista-treino-a" style="list-style: none; padding: 0;">
                    <li class="exercicio-item" data-exercicio="Esteira">
                        <div class="exercicio-info"><strong>Esteira</strong><span>30 Min | 1 Vez</span></div>
                        <div class="checkbox-container"><input type="checkbox" onchange="marcarConcluido(this, 'Dia A', 'Esteira')"></div>
                    </li>
                </ul>
            </div>

            <div id="treino-Dia B" class="lista-treino-dia" style="display: none;">
                <h3>Dia B: Costas e B√≠ceps</h3>
                <ul id="lista-treino-b" style="list-style: none; padding: 0;">
                    <li class="exercicio-item" data-exercicio="PuxadaFrontal">
                        <div class="exercicio-info"><strong>Puxada Frontal</strong><span>4x12 | 60s</span></div>
                        <div class="checkbox-container"><input type="checkbox" onchange="marcarConcluido(this, 'Dia B', 'PuxadaFrontal')"></div>
                    </li>
                </ul>
            </div>

            <div id="treino-Dia C" class="lista-treino-dia" style="display: none;">
                <h3>Dia C: Pernas</h3>
                <ul id="lista-treino-c" style="list-style: none; padding: 0;">
                    <li class="exercicio-item" data-exercicio="Extensora">
                        <div class="exercicio-info"><strong>Cadeira Extensora</strong><span>4x15 | 45s</span></div>
                        <div class="checkbox-container"><input type="checkbox" onchange="marcarConcluido(this, 'Dia C', 'Extensora')"></div>
                    </li>
                </ul>
            </div>
        </div>

        <div id="presenca-card" class="card">
            <h2>üóìÔ∏è Presen√ßa Mensal</h2>
            <p>Clique nas datas para marcar.</p>
            <table class="presenca-table">
                <thead><tr><th>Dom</th><th>Seg</th><th>Ter</th><th>Qua</th><th>Qui</th><th>Sex</th><th>S√°b</th></tr></thead>
                <tbody id="calendario-body"></tbody>
            </table>
            <button class="reset-btn" onclick="resetarDados('presenca')">Resetar Presen√ßas</button>
        </div>

    </div>

    <script>
        // CONFIGURA√á√ÉO FIREBASE (MANTIDO O SEU)
        const firebaseConfig = {
            apiKey: "AIzaSyQDLkdyL4qgoEj1YqBr2xCs0F3aM1o82ef0",
            authDomain: "ptf03-26fdb.firebaseapp.com",
            databaseURL: "https://ptf03-26fdb-default-rtdb.firebaseio.com",
            projectId: "ptf03-26fdb",
            storageBucket: "ptf03-26fdb.firebaseapp.com",
            messagingSenderId: "1020981883676",
            appId: "1:1020981883676:web:7b26aca25ddb1dc02100d9"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let alunoNome = '';
        let pesoChart;

        function getPath(sub) { return `alunos/${alunoNome.replace(/\s/g, '_')}/${sub}`; }

        function obterNomeAluno() {
            alunoNome = localStorage.getItem('nomeAluno');
            if (!alunoNome) {
                document.getElementById('modal-nome').style.display = 'flex';
            } else {
                start();
            }
        }

        function salvarNomeModal() {
            let n = document.getElementById('nomeModalInput').value.trim();
            if(n) {
                alunoNome = n.split(' ').map(w => w[0].toUpperCase() + w.slice(1).toLowerCase()).join(' ');
                localStorage.setItem('nomeAluno', alunoNome);
                document.getElementById('modal-nome').style.display = 'none';
                start();
            }
        }

        function start() {
            document.getElementById('nome-aluno').textContent = alunoNome;
            document.getElementById('main-title').textContent = `Bem-vindo, ${alunoNome.split(' ')[0]}!`;
            document.getElementById('data-atual').textContent = new Date().toLocaleDateString('pt-BR');
            
            inicializarGrafico();
            carregarUltimasMedidas();
            alternarTreino();
            gerarCalendario();
        }

        // --- GR√ÅFICO (CORRIGIDO) ---
        function inicializarGrafico() {
            const ex = document.getElementById('seletorExercicio').value;
            
            if(pesoChart) { pesoChart.destroy(); }

            // Usa 'once' em vez de 'on' para evitar recarregar o gr√°fico infinitamente
            database.ref(getPath(`cargas/${ex}`)).once('value', snap => { 
                const dados = [];
                snap.forEach(d => dados.push(d.val()));
                
                dados.sort((a,b) => a.timestamp - b.timestamp);

                const ctx = document.getElementById('pesoChart').getContext('2d');
                
                if(pesoChart) pesoChart.destroy();
                
                pesoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        // Se n√£o houver dados, usa 'In√≠cio', se houver, usa as datas
                        labels: dados.length ? dados.map(d => d.data) : ['In√≠cio'], 
                        datasets: [{
                            label: `Carga ${ex} (kg)`,
                            data: dados.length ? dados.map(d => d.peso) : [0],
                            borderColor: '#ff8c00', 
                            backgroundColor: 'rgba(255,140,0,0.2)', 
                            fill: true,
                            tension: 0.3,
                            // Garante que o ponto inicial '0' n√£o seja exibido se houver dados
                            pointRadius: dados.length ? 5 : 0 
                        }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        scales: { 
                            y: { beginAtZero: true, grid: { color: '#333'} }, 
                            x: { 
                                grid: { color: '#333'},
                                // CORRE√á√ÉO CR√çTICA: Desativa autoSkip para garantir que todos os pontos sejam renderizados
                                ticks: {
                                    autoSkip: false, // DESLIGA o agrupamento autom√°tico de r√≥tulos
                                    maxRotation: 45, // Gira o texto para evitar sobreposi√ß√£o
                                    minRotation: 45 
                                }
                            } 
                        },
                        plugins: {
                            legend: {
                                display: true
                            }
                        }
                    }
                });
            });
        }

        function adicionarPeso() {
            const p = document.getElementById('pesoInput').value;
            if(!p || isNaN(parseFloat(p))) {
                 alert('Por favor, insira uma carga v√°lida.');
                 return;
            }
            const ex = document.getElementById('seletorExercicio').value;
            
            // AGORA SALVA DATA, HORA E SEGUNDOS PARA GARANTIR QUE OS PONTOS SEJAM √öNICOS
            const agora = new Date();
            const dataLegivel = agora.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'}) + 
                                ' ' + 
                                agora.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', second: '2-digit'});

            database.ref(getPath(`cargas/${ex}`)).push({
                data: dataLegivel, 
                peso: parseFloat(p),
                timestamp: Date.now()
            }).then(() => {
                document.getElementById('pesoInput').value = '';
                // Recarrega o gr√°fico ap√≥s adicionar um ponto
                inicializarGrafico(); 
            });
        }

        // --- MEDIDAS ---
        function registrarMedidas() {
            // [c√≥digo de registro de medidas mantido como seu original]
            const peso = document.getElementById('pesoCorporalInput').value;
            if(!peso) return alert('O peso √© obrigat√≥rio!');

            const m = {
                data: new Date().toLocaleDateString('pt-BR'),
                timestamp: Date.now(),
                peso: peso,
                cintura: document.getElementById('cinturaInput').value,
                braco: document.getElementById('bracoInput').value,
                torax: document.getElementById('toraxInput').value,
                abdomen: document.getElementById('abdomenInput').value,
                coxa: document.getElementById('coxaInput').value,
                panturrilha: document.getElementById('panturrilhaInput').value,
                antebraco: document.getElementById('antebracoInput').value
            };
            
            database.ref(getPath('medidas')).push(m);
            alert('Medidas Salvas!');
            document.querySelectorAll('#medidas-card input').forEach(i => i.value = '');
            carregarUltimasMedidas();
        }

        function carregarUltimasMedidas() {
            // [c√≥digo de carregamento de medidas mantido como seu original]
            database.ref(getPath('medidas')).limitToLast(1).once('value', snap => {
                const div = document.getElementById('ultimasMedidas');
                div.innerHTML = 'Nenhum registro encontrado.';
                snap.forEach(c => {
                    const d = c.val();
                    div.innerHTML = `<strong>${d.data}</strong>: ${d.peso}kg | Cintura: ${d.cintura||'-'} | Bra√ßo: ${d.braco||'-'}`;
                });
            });
        }

        // --- TREINO (SINCRONIZADO E CORRIGIDO) ---

        function alternarTreino() {
            const dia = document.getElementById('seletorTreino').value;
            document.querySelectorAll('.lista-treino-dia').forEach(e => e.style.display = 'none');
            document.getElementById(`treino-${dia}`).style.display = 'block';
            
            carregarTreinoDoProfessor(dia);
        }
        
        function marcarConcluido(chk, dia, id) {
            const li = chk.closest('li');
            chk.checked ? li.classList.add('concluido') : li.classList.remove('concluido');
            database.ref(getPath(`treino_status/${dia}/${id}`)).set(chk.checked);
        }

        function carregarCheckboxes(dia) {
            // Essa fun√ß√£o √© chamada dentro de carregarTreinoDoProfessor
            database.ref(getPath(`treino_status/${dia}`)).once('value', snap => {
                const s = snap.val() || {};
                document.getElementById(`treino-${dia}`).querySelectorAll('li').forEach(li => {
                    const id = li.getAttribute('data-exercicio');
                    const chk = li.querySelector('input[type="checkbox"]');
                    if(chk && s[id]) { chk.checked = true; li.classList.add('concluido'); }
                });
            });
        }

        function carregarTreinoDoProfessor(dia) {
            const idLista = dia === 'Dia A' ? 'lista-treino-a' : (dia === 'Dia B' ? 'lista-treino-b' : 'lista-treino-c');
            const ul = document.getElementById(idLista);
            
            database.ref(getPath(`treinoModel/${dia}`)).on('value', snap => {
                const treinoData = snap.val();
                let novoTreino = [];

                // CORRE√á√ÉO: Converte o objeto do Firebase (que cont√©m o treino) em um Array.
                if (treinoData) {
                    // Se for um Array (m√©todo do professor que usa .push()), usa diretamente
                    if (Array.isArray(treinoData)) {
                        novoTreino = treinoData;
                    } else {
                        // Se for um Objeto (m√©todo do professor que usa .set()), converte as chaves em array
                        novoTreino = Object.keys(treinoData).map(key => treinoData[key]);
                    }
                }

                if(novoTreino.length > 0) {
                    ul.innerHTML = ''; // Limpa a lista antes de carregar
                    novoTreino.forEach(t => {
                        const nomeExercicioLimpo = t.nome.replace(/\s/g, '');
                        const li = document.createElement('li');
                        li.className = 'exercicio-item';
                        // Garante que o atributo data-exercicio seja o nome limpo do exerc√≠cio
                        li.setAttribute('data-exercicio', nomeExercicioLimpo); 
                        li.innerHTML = `
                            <div class="exercicio-info"><strong>${t.nome}</strong><span>${t.series || '4'}x | ${t.reps || '12'}</span></div>
                            <div class="checkbox-container"><input type="checkbox" onchange="marcarConcluido(this, '${dia}', '${nomeExercicioLimpo}')"></div>
                        `;
                        ul.appendChild(li);
                    });
                    // Depois de montar o treino, carrega os status de conclu√≠do
                    carregarCheckboxes(dia);
                }
            });
        }
        
        // --- PRESEN√áA ---
        function gerarCalendario() {
            // [c√≥digo de calend√°rio mantido como seu original]
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            const primeiroDiaSemana = new Date(anoAtual, mesAtual, 1).getDay();
            const ultimoDiaMes = new Date(anoAtual, mesAtual + 1, 0).getDate();
            
            let html = '<tr>';
            let contadorDias = 1;

            for (let i = 0; i < 6; i++) {
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < primeiroDiaSemana) {
                        html += '<td></td>';
                    } else if (contadorDias > ultimoDiaMes) {
                        html += '<td></td>';
                    } else {
                        const chaveData = `${String(contadorDias).padStart(2,'0')}-${String(mesAtual+1).padStart(2,'0')}-${anoAtual}`;
                        html += `<td id="dia-${chaveData}" onclick="togglePresenca('${chaveData}')">${contadorDias}</td>`;
                        contadorDias++;
                    }
                }
                html += '</tr>';
                if (contadorDias > ultimoDiaMes) break;
            }
            document.getElementById('calendario-body').innerHTML = html;
            carregarPresencas();
        }

        function togglePresenca(key) {
            // [c√≥digo de togglePresenca mantido como seu original]
            const td = document.getElementById(`dia-${key}`);
            const status = td.classList.contains('presente');
            if(status) {
                database.ref(getPath(`presenca/${key}`)).remove();
                td.classList.remove('presente');
            } else {
                database.ref(getPath(`presenca/${key}`)).set(true);
                td.classList.add('presente');
            }
        }

        function carregarPresencas() {
            // [c√≥digo de carregarPresencas mantido como seu original]
            database.ref(getPath('presenca')).on('value', snap => {
                const p = snap.val() || {};
                Object.keys(p).forEach(k => {
                    const td = document.getElementById(`dia-${k}`);
                    if(td) td.classList.add('presente');
                });
            });
        }

        // --- RESETAR DADOS (Corrigido para o gr√°fico) ---
        function resetarDados(tipo) {
            if(confirm('Tem certeza? Isso apagar√° o hist√≥rico.')) {
                let p = tipo === 'presenca' ? 'presenca' : (tipo === 'cargas' ? `cargas/${document.getElementById('seletorExercicio').value}` : 'medidas');
                
                database.ref(getPath(p)).remove()
                    .then(() => {
                        alert('Apagado.');
                        if(tipo === 'cargas') {
                            // Ap√≥s apagar os dados de carga, reinicia o gr√°fico.
                            inicializarGrafico(); 
                        }
                        if(tipo === 'medidas') {
                            document.getElementById('ultimasMedidas').innerHTML = 'Nenhum registro encontrado.';
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao resetar dados:", error);
                        alert("Erro ao apagar dados. Verifique o console.");
                    });
            }
        }
    </script>
</body>
</html>
