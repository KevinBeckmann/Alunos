<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Treinador - Admin (Sincronizado)</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>

    <style>
        /* --- CSS DARK MODE --- */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            /* Fundo escuro */
            color: #e0e0e0;
        }

        h1,
        h2 {
            color: #00d4ff;
            text-align: center;
        }

        .main-header {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .main-header img {
            max-width: 40px;
            height: auto;
            margin-right: 10px;
        }

        .main-header h1 {
            margin: 0;
            color: #00d4ff;
            font-size: 2em;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 1fr 2fr;
            }
        }

        .card {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* --- Estilos do Formul√°rio de Edi√ß√£o --- */
        label {
            display: block;
            margin-top: 10px;
            color: #aaa;
            font-size: 0.9em;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            color: white;
            box-sizing: border-box;
        }

        button.btn-save {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: #00d4ff;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }

        button.btn-save:hover {
            background-color: #00a3cc;
        }

        /* --- Grid de Inputs do Treino (CORRIGIDO PARA TER 4 COLUNAS) --- */
        .treino-row {
            display: grid;
            /* Garante 4 colunas: Exerc√≠cio, S√©rie, Reps, Bot√£o Remover */
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #333;
            align-items: end;
            /* Alinha os itens na base, importante para o bot√£o */
        }

        .btn-remover {
            padding: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            /* Garante que o bot√£o tenha a altura correta */
            height: 40px;
            margin-bottom: 5px;
        }


        /* Estilos para a lista de frequ√™ncia */
        #lista-presenca li {
            padding: 5px 0;
            border-bottom: 1px dotted #333;
        }
    </style>
</head>

<body>

    <div class="main-header">
        <img src="logotipo.png" alt="Logo do Personal" /> 
        <h1>Painel do Personal</h1>
    </div>

    <div class="container">

        <div class="left-col">
            <div class="card">
                <h2>‚úèÔ∏è Editar Treino</h2>

                <label>Selecione o Aluno:</label>
                <select id="selectAluno">
                    <option disabled selected>Carregando Alunos...</option>
                </select>

                <label>Dia do Treino:</label>
                <select id="selectDia">
                    <option value="Dia A">Dia A (Peito/Ombro)</option>
                    <option value="Dia B">Dia B (Costas/B√≠ceps)</option>
                    <option value="Dia C">Dia C (Pernas)</option>
                </select>

                <hr style="border-color: #333; margin: 20px 0;">

                <div id="editor-container">
                    <p style="color: #aaa;">Selecione um aluno e um dia para carregar o treino.</p>
                </div>

                <button class="btn-save" onclick="salvarTreino()">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>

        <div class="right-col">
            <div class="card">
                <h2 id="titulo-acompanhamento">üìä Acompanhamento do Aluno</h2>

                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <span style="color: #aaa;">Gr√°fico:</span>
                        <select id="selectGrafico" onchange="inicializarGraficoAluno(this.value)">
                            <option value="AgachamentoLivre">Agachamento Livre</option>
                            <option value="SupinoReto">Supino Reto</option>
                            <option value="PuxadaFrontal">Puxada Frontal</option>
                            <option value="OutroExercicio">Outro Exerc√≠cio (Ajustar)</option>
                        </select>
                    </div>
                </div>

                <div style="height: 300px;">
                    <canvas id="chartAdmin"></canvas>
                </div>

                <h3 style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">√öltimas Medidas (Peso e
                    Cintura)</h3>
                <table style="width: 100%; text-align: left; font-size: 0.9em;">
                    <thead>
                        <tr style="color: #aaa;">
                            <th>Data</th>
                            <th>Peso</th>
                            <th>Cintura</th>
                            <th>Bra√ßo</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-medidas-admin">
                        <tr>
                            <td colspan="4">Nenhum aluno selecionado.</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h2>üìÖ Frequ√™ncia e Presen√ßa</h2>
                <div id="status-frequencia" style="color: #00d4ff; font-weight: bold; margin-bottom: 15px;">
                    Selecione um aluno para ver o hist√≥rico.
                </div>
                <ul id="lista-presenca" style="list-style-type: none; padding: 0;">
                </ul>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // === CONFIGURA√á√ÉO DO FIREBASE (VERIFIQUE E MANTENHA SUAS CHAVES CORRETAS) ===
        // =================================================================
        const firebaseConfig = {
            // As chaves a seguir devem ser as suas chaves corretas e completas
            apiKey: "AIzaSyQDLkdyL4qgoEj1YqBr2xCs0F3aM1o82ef0", // <--- PREENCHER
            authDomain: "ptf03-26fdb.firebaseapp.com", // <--- PREENCHER
            databaseURL: "https://ptf03-26fdb-default-rtdb.firebaseio.com", // <--- PREENCHER
            projectId: "ptf03-26fdb", // <--- PREENCHER
            storageBucket: "ptf03-26fdb.firebaseapp.com", // <--- PREENCHER
            messagingSenderId: "1020981883676", // <--- PREENCHER
            appId: "1:1020981883676:web:7b26aca25ddb1dc02100d9" // <--- PREENCHER
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const CAMINHO_ALUNOS = 'alunos/';
        let alunoSelecionadoNome = '';
        let pesoChart; // Vari√°vel global para armazenar a inst√¢ncia do Chart.js

        // =================================================================
        // === AUXILIARES E CONVERS√ÉO DE NOME (CR√çTICO PARA PRECISAO) ===
        // =================================================================

        function formatarNomeParaChave(nome) {
            // CR√çTICO: Deve replicar EXATAMENTE a l√≥gica usada na fun√ß√£o salvarNomeModal() do painel do aluno.
            if (!nome) return '';
            
            // L√≥gica do aluno: Capitaliza a primeira letra de cada palavra e substitui espa√ßos por sublinhado.
            return nome.trim().split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join('_');
        }

        function obterCaminhoAluno(childKey) {
            const nomeFormatado = formatarNomeParaChave(alunoSelecionadoNome);
            // Exemplo de retorno: 'alunos/Maria_Silva/medidas'
            return `${CAMINHO_ALUNOS}${nomeFormatado}/${childKey}`;
        }

        // =================================================================
        // === FUN√á√ÉO CENTRAL DE SINCRONIZA√á√ÉO ===
        // =================================================================

        function carregarDadosDoAlunoSelecionado() {
            if (!alunoSelecionadoNome) return;

            // 1. Recarrega o editor de treino
            carregarTreinoDia();

            // 2. Recarrega o hist√≥rico de acompanhamento
            carregarHistoricoMedidas();
            carregarHistoricoPresenca();

            // 3. Recarrega e redesenha o gr√°fico
            const exercicioInicial = document.getElementById('selectGrafico').value;
            inicializarGraficoAluno(exercicioInicial);

            document.getElementById('titulo-acompanhamento').textContent = `üìä Acompanhamento de ${alunoSelecionadoNome.split(' ')[0]}`;
        }


        // =================================================================
        // === 1. CARREGAR LISTA DE ALUNOS E ATIVAR LISTENERS ===
        // =================================================================

        function carregarListaDeAlunos() {
            const selectAluno = document.getElementById('selectAluno');
            const selectDia = document.getElementById('selectDia');
            selectAluno.innerHTML = '<option disabled selected>Carregando...</option>';

            database.ref(CAMINHO_ALUNOS).once('value', (snapshot) => {
                const todosAlunos = snapshot.val();
                selectAluno.innerHTML = '';

                if (!todosAlunos) {
                    selectAluno.innerHTML = '<option disabled selected>Nenhum aluno encontrado.</option>';
                    document.getElementById('editor-container').innerHTML = '<p style="color: #dc3545;">Nenhum aluno registrado no banco de dados no caminho /alunos/.</p>';
                    return;
                }

                let primeiroAlunoNome = null;

                for (const nomeAlunoFormatado in todosAlunos) {
                    // Reverte a chave para um nome leg√≠vel: "Maria_Silva" -> "Maria Silva"
                    const nomeLegivel = nomeAlunoFormatado.replace(/_/g, ' ');

                    const option = document.createElement('option');
                    option.value = nomeLegivel;
                    option.textContent = nomeLegivel;
                    selectAluno.appendChild(option);

                    if (!primeiroAlunoNome) {
                        primeiroAlunoNome = nomeLegivel;
                    }
                }

                if (primeiroAlunoNome) {
                    alunoSelecionadoNome = primeiroAlunoNome;
                    selectAluno.value = primeiroAlunoNome;
                    // Carrega dados do primeiro aluno automaticamente
                    carregarDadosDoAlunoSelecionado();
                }

                // EVENT LISTENERS (GARANTE A SINCRONIZA√á√ÉO A CADA TROCA)
                selectAluno.onchange = (e) => {
                    alunoSelecionadoNome = e.target.value;
                    carregarDadosDoAlunoSelecionado();
                };

                selectDia.onchange = carregarTreinoDia;

            }, (error) => {
                selectAluno.innerHTML = `<option disabled>Erro de Conex√£o (${error.code})</option>`;
                console.error("Erro ao carregar lista de alunos:", error);
            });
        }

        // =================================================================
        // === 2. EDI√á√ÉO E SALVAMENTO DO TREINO (AJUSTADO) ===
        // =================================================================

        function carregarTreinoDia() {
            const dia = document.getElementById('selectDia').value;
            const editorContainer = document.getElementById('editor-container');
            if (!alunoSelecionadoNome) return;

            editorContainer.innerHTML = 'Carregando treino...';

            // ATEN√á√ÉO: O painel do aluno N√ÉO usa 'treinoModel', ele usa os nomes dos dias 'Dia A', 'Dia B' etc.
            // Para editar, vamos usar uma nova chave 'treinoModel' no Firebase, que o aluno vai ler.
            // NO ENTANTO, para a edi√ß√£o no Painel do Personal refletir no painel do aluno, 
            // precisamos que o painel do aluno **leia** o modelo aqui salvo.
            // Vou assumir que o novo modelo de treino ser√° salvo na chave: `/alunos/[Nome_Aluno]/treinoModel/[Dia X]`
            // E o painel do aluno ser√° ajustado para ler dessa nova chave.
            
            // Para simplicidade, vamos usar o mesmo formato de treino do exemplo anterior (Dia A/B/C)
            // e salvar na chave do dia, ignorando o "treinoModel" por enquanto, para compatibilidade.
            // CHAVE DE EDI√á√ÉO: `/alunos/[Nome_Aluno]/treinoModel/Dia A`
            const firebaseRef = database.ref(obterCaminhoAluno('treinoModel') + '/' + dia);

            firebaseRef.once('value', (snapshot) => {
                const treinoModel = snapshot.val();
                editorContainer.innerHTML = '';

                // Verifica se os dados do treino est√£o no formato de Array de objetos (nome, series, reps)
                if (treinoModel && Array.isArray(treinoModel)) {
                    treinoModel.forEach(exercicio => {
                        // Verifica se o objeto exercicio tem as propriedades esperadas
                        const nome = exercicio.nome || '';
                        const series = exercicio.series || '';
                        const reps = exercicio.reps || '';

                        adicionarLinhaExercicio(editorContainer, nome, series, reps);
                    });
                } else {
                    // Adiciona um exemplo se o treino estiver vazio/inv√°lido
                    adicionarLinhaExercicio(editorContainer, 'Ex: Supino Reto', '4', '10-12');
                }

                const btnAdd = document.createElement('button');
                btnAdd.textContent = '‚ûï Adicionar Exerc√≠cio';
                // Define a fun√ß√£o de adicionar com uma linha vazia
                btnAdd.onclick = () => adicionarLinhaExercicio(editorContainer, '', '', '');
                btnAdd.style.cssText = 'width: 100%; padding: 8px; margin-top: 10px; background-color: #38c172; color: white; border: none; border-radius: 4px; cursor: pointer;';
                editorContainer.appendChild(btnAdd);

            }, (error) => {
                editorContainer.innerHTML = `<p style="color: #dc3545;">Erro ao carregar treino: ${error.message}</p>`;
            });
        }

        function adicionarLinhaExercicio(container, nome = '', series = '', reps = '') {
            const row = document.createElement('div');
            row.className = 'treino-row';
            row.innerHTML = `
                <div>
                    <label>Exerc√≠cio</label>
                    <input type="text" class="input-exercicio" value="${nome}" placeholder="Nome do exerc√≠cio">
                </div>
                <div>
                    <label>S√©ries</label>
                    <input type="text" class="input-series" value="${series}" placeholder="Ex: 4">
                </div>
                <div>
                    <label>Reps</label>
                    <input type="text" class="input-reps" value="${reps}" placeholder="Ex: 12">
                </div>
                <div>
                    <button type="button" class="btn-remover">X</button>
                </div>
            `;
            // ADI√á√ÉO CR√çTICA: Listener para o bot√£o Remover em cada linha
            row.querySelector('.btn-remover').onclick = () => row.remove();

            // Encontra o bot√£o de adicionar exerc√≠cio (que deve ser o √∫ltimo elemento) e insere a linha antes dele.
            const btnAdd = container.querySelector('button');
            container.insertBefore(row, btnAdd || null);
        }

        function salvarTreino() {
            if (!alunoSelecionadoNome) {
                alert('Selecione um aluno primeiro.');
                return;
            }

            const dia = document.getElementById('selectDia').value;
            const linhas = document.getElementById('editor-container').querySelectorAll('.treino-row');

            const novoTreino = [];

            linhas.forEach(linha => {
                const exercicio = linha.querySelector('.input-exercicio').value.trim();
                const series = linha.querySelector('.input-series').value.trim();
                const reps = linha.querySelector('.input-reps').value.trim();

                // Salva apenas linhas que cont√™m informa√ß√µes de treino v√°lidas
                if (exercicio && series && reps) {
                    novoTreino.push({ nome: exercicio, series: series, reps: reps });
                }
            });

            if (novoTreino.length === 0) {
                if (!confirm("Voc√™ est√° salvando um treino vazio. Deseja continuar?")) {
                    return;
                }
            }

            // CHAVE DE EDI√á√ÉO: `/alunos/[Nome_Aluno]/treinoModel/[Dia X]`
            const firebaseRef = database.ref(obterCaminhoAluno('treinoModel') + '/' + dia);

            firebaseRef.set(novoTreino)
                .then(() => {
                    alert(`‚úÖ Treino ${dia} de ${alunoSelecionadoNome} atualizado e publicado com sucesso!`);
                })
                .catch((error) => {
                    console.error("Erro ao salvar treino:", error);
                    alert(`‚ùå Erro ao salvar treino: ${error.message}`);
                });
        }


        // =================================================================
        // === 3. VISUALIZA√á√ÉO DE DADOS (Medidas e Gr√°fico) - AJUSTADO ===
        // =================================================================

        function carregarHistoricoMedidas() {
            const tableBody = document.getElementById('tabela-medidas-admin');
            tableBody.innerHTML = '<tr><td colspan="4">Carregando hist√≥rico...</td></tr>';

            // CHAVE DO ALUNO: O aluno salva em: /alunos/[Nome_Aluno]/medidas
            const firebaseRef = database.ref(obterCaminhoAluno('medidas')).orderByChild('timestamp').limitToLast(10);

            firebaseRef.once('value', (snapshot) => {
                const medidas = snapshot.val();
                tableBody.innerHTML = '';

                if (!medidas) {
                    tableBody.innerHTML = '<tr><td colspan="4">Nenhum registro de medidas.</td></tr>';
                    return;
                }

                // Ordena pelo timestamp e inverte a ordem para mostrar o mais recente no topo
                const medidasArray = Object.values(medidas).sort((a, b) => (a.timestamp > b.timestamp ? -1 : 1));

                medidasArray.forEach(m => {
                    // Cuidado com a formata√ß√£o de dados!
                    const dataFormatada = m.data ? m.data.replace(/-/g, '/') : '?'; // Data vinda do aluno √© 01/11/2025
                    const peso = m.peso !== undefined ? `${m.peso} kg` : '?'; // O aluno salva como 'peso', n√£o 'pesoCorporal'
                    const cintura = m.cintura !== undefined ? `${m.cintura} cm` : '?';
                    const braco = m.braco !== undefined ? `${m.braco} cm` : '?'; // Adicionado bra√ßo para mais detalhes

                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${dataFormatada}</td>
                        <td>${peso}</td>
                        <td>${cintura}</td>
                        <td>${braco}</td>
                    `;
                });
            });
        }

        function inicializarGraficoAluno(exercicioKey) {
            if (pesoChart) {
                pesoChart.destroy();
            }

            // As chaves no Firebase n√£o devem ter espa√ßos. Ex: "SupinoReto"
            const exercicioPath = exercicioKey.replace(/ /g, '_');

            // CHAVE DO ALUNO: /alunos/[Nome_Aluno]/cargas/agachamentoLivre
            const firebaseRef = database.ref(obterCaminhoAluno('cargas') + '/' + exercicioPath);

            firebaseRef.once('value', (snapshot) => {
                const dadosSalvos = [];
                snapshot.forEach(childSnapshot => {
                    dadosSalvos.push(childSnapshot.val());
                });

                // Ordena os dados por timestamp (para garantir a ordem correta no gr√°fico)
                dadosSalvos.sort((a, b) => a.timestamp - b.timestamp);

                const labels = dadosSalvos.map(d => d && d.data ? d.data.substring(0, 5) : '');
                const pesos = dadosSalvos.map(d => d && d.peso !== undefined ? d.peso : 0);

                const ctx = document.getElementById('chartAdmin').getContext('2d');

                pesoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.length > 0 && pesos.some(p => p > 0) ? labels : ['Sem Dados'],
                        datasets: [{
                            label: `Carga ${exercicioKey} (kg)`,
                            data: pesos.length > 0 ? pesos : [0],
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            pointBackgroundColor: '#00d4ff',
                            pointBorderColor: '#fff',
                            tension: 0.4,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Carga (kg)',
                                    color: '#aaa'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#aaa'
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                ticks: {
                                    color: '#aaa'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e0e0e0'
                                }
                            }
                        }
                    }
                });
            });
        }

        // =================================================================
        // === 4. CARREGAR FREQU√äNCIA (AJUSTADO) ===
        // =================================================================

        function carregarHistoricoPresenca() {
            const listaPresenca = document.getElementById('lista-presenca');
            const statusDiv = document.getElementById('status-frequencia');
            listaPresenca.innerHTML = '';
            statusDiv.textContent = 'Carregando frequ√™ncia...';

            if (!alunoSelecionadoNome) {
                statusDiv.textContent = 'Selecione um aluno para ver o hist√≥rico.';
                return;
            }

            // CHAVE DO ALUNO: /alunos/[Nome_Aluno]/presenca
            const firebaseRef = database.ref(obterCaminhoAluno('presenca'));

            firebaseRef.once('value', (snapshot) => {
                const presenca = snapshot.val();
                let totalPresencas = 0;

                if (!presenca) {
                    statusDiv.textContent = '‚ö†Ô∏è Nenhum registro de presen√ßa encontrado.';
                    return;
                }

                // Obt√©m as chaves (datas) e armazena apenas as datas em que o valor √© 'true' (presente)
                const datasPresentes = Object.keys(presenca).filter(chave => {
                    if (presenca[chave] === true) {
                        totalPresencas++;
                        return true;
                    }
                    return false;
                }).reverse(); // Inverte para mostrar as mais recentes primeiro

                statusDiv.textContent = `‚úÖ Total de Presen√ßas Registradas: ${totalPresencas} vezes`;

                if (totalPresencas === 0) {
                    statusDiv.textContent = 'Nenhuma presen√ßa marcada.';
                }

                datasPresentes.forEach(chaveData => {
                    // A data √© salva como chave XX-XX-XXXX (Ex: 01-11-2025). Vamos formatar para leitura XX/XX/XXXX
                    const dataLegivel = chaveData.replace(/-/g, '/');

                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span style="display: flex; justify-content: space-between;">
                            <span>‚úÖ Data:</span> <span>${dataLegivel}</span>
                        </span>
                    `;
                    listaPresenca.appendChild(li);
                });

            });
        }


        // =================================================================
        // === INICIALIZA√á√ÉO ===
        // =================================================================

        document.addEventListener('DOMContentLoaded', carregarListaDeAlunos);
    </script>
</body>

</html>
