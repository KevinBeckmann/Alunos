<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Treinador - Admin</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>

    <style>
        /* --- CSS DARK MODE (Baseado no do Aluno para consist√™ncia) --- */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #121212; /* Fundo escuro */
            color: #e0e0e0;
        }

        h1, h2 { color: #00d4ff; text-align: center; } /* Azul para diferenciar do aluno (Laranja) */
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 1024px) {
            .container { grid-template-columns: 1fr 2fr; } /* Editor menor, Gr√°ficos maior */
        }

        .card {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* --- Estilos do Formul√°rio de Edi√ß√£o --- */
        label { display: block; margin-top: 10px; color: #aaa; font-size: 0.9em; }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            color: white;
            box-sizing: border-box;
        }

        button.btn-save {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: #00d4ff;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        button.btn-save:hover { background-color: #00a3cc; }

        /* --- Estilos da Lista de Alunos (N√£o usada na v. atual, mas mantida no CSS) --- */
        .aluno-item {
            padding: 15px;
            border-bottom: 1px solid #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
        }
        .aluno-item:hover { background-color: #2c2c2c; }
        .status-ok { color: #4caf50; font-size: 0.8em; }

        /* --- Grid de Inputs do Treino --- */
        .treino-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #333;
        }
    </style>
</head>
<body>

    <h1>üõ°Ô∏è Painel do Personal</h1>

    <div class="container">
        
        <div class="left-col">
            <div class="card">
                <h2>‚úèÔ∏è Editar Treino</h2>
                
                <label>Selecione o Aluno:</label>
                <select id="selectAluno">
                    </select>

                <label>Dia do Treino:</label>
                <select id="selectDia">
                    <option value="A">Dia A (Peito/Ombro)</option>
                    <option value="B">Dia B (Costas/B√≠ceps)</option>
                    <option value="C">Dia C (Pernas)</option>
                </select>
                
                <hr style="border-color: #333; margin: 20px 0;">

                <div id="editor-container">
                    <p style="color: #aaa;">Selecione um aluno e um dia para carregar o treino.</p>
                </div>

                <button class="btn-save" onclick="salvarTreino()">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>

        <div class="right-col">
            <div class="card">
                <h2 id="titulo-acompanhamento">üìä Acompanhamento do Aluno</h2>
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <span style="color: #aaa;">Gr√°fico:</span> 
                        <select id="selectGrafico" onchange="inicializarGraficoAluno(this.value)">
                            <option value="AgachamentoLivre">Agachamento Livre</option>
                            <option value="SupinoReto">Supino Reto</option>
                            <option value="PuxadaFrontal">Puxada Frontal</option>
                        </select>
                    </div>
                </div>

                <div style="height: 300px;">
                    <canvas id="chartAdmin"></canvas>
                </div>
                
                <h3 style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">√öltimas Medidas (Peso e Cintura)</h3>
                <table style="width: 100%; text-align: left; font-size: 0.9em;">
                    <thead>
                        <tr style="color: #aaa;">
                            <th>Data</th>
                            <th>Peso</th>
                            <th>Cintura</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-medidas-admin">
                        <tr><td colspan="3">Nenhum aluno selecionado.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // === CONFIGURA√á√ÉO DO FIREBASE (SUBSTITUA PELAS SUAS CHAVES) ===
        // =================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyQDLkdyL4qgoEj1YqBr2xCs0F3aM1o82ef0",
            authDomain: "ptf03-26fdb.firebaseapp.com",
            databaseURL: "https://ptf03-26fdb-default-rtdb.firebaseio.com",
            projectId: "ptf03-26fdb",
            storageBucket: "ptf03-26fdb.firebaseapp.com",
            messagingSenderId: "1020981883676",
            appId: "1:1020981883676:web:7b26aca25ddb1dc02100d9"
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Caminhos principais
        const CAMINHO_ALUNOS = 'alunos/';
        let alunoSelecionadoNome = '';
        let pesoChart; // Vari√°vel para o gr√°fico

        // =================================================================
        // === AUXILIARES E CONVERS√ÉO DE NOME ===
        // =================================================================

        /**
         * Converte o nome leg√≠vel (ex: "Jo√£o da Silva") para o formato de chave do Firebase (ex: "Jo√£o_da_Silva").
         */
        function formatarNomeParaChave(nome) {
            if (!nome) return '';
            // Converte para Title Case e substitui espa√ßos por '_'
            return nome.trim().split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join('_');
        }

        /**
         * Retorna o caminho completo para o n√≥ do Firebase do aluno selecionado.
         */
        function obterCaminhoAluno(childKey) {
            const nomeFormatado = formatarNomeParaChave(alunoSelecionadoNome);
            return `${CAMINHO_ALUNOS}${nomeFormatado}/${childKey}`;
        }

        // =================================================================
        // === 1. CARREGAR LISTA DE ALUNOS (Inicializa√ß√£o) ===
        // =================================================================

        function carregarListaDeAlunos() {
            const selectAluno = document.getElementById('selectAluno');
            selectAluno.innerHTML = '<option disabled selected>Carregando...</option>';

            // 1. L√™ o n√≥ principal 'alunos/' (todos os alunos)
            database.ref(CAMINHO_ALUNOS).once('value', (snapshot) => {
                const todosAlunos = snapshot.val();
                selectAluno.innerHTML = ''; // Limpa o "Carregando..."
                
                if (!todosAlunos) {
                    selectAluno.innerHTML = '<option disabled selected>Nenhum aluno encontrado.</option>';
                    document.getElementById('editor-container').innerHTML = '<p style="color: #aaa;">Nenhum aluno registrado no banco de dados.</p>';
                    return;
                }

                let primeiroAlunoNome = null;
                
                // Itera sobre os alunos no Firebase (a chave √© o nome formatado)
                for (const nomeAlunoFormatado in todosAlunos) {
                    // Converte de volta para nome leg√≠vel
                    const nomeLegivel = nomeAlunoFormatado.replace(/_/g, ' '); 
                    
                    const option = document.createElement('option');
                    option.value = nomeLegivel;
                    option.textContent = nomeLegivel;
                    selectAluno.appendChild(option);

                    if (!primeiroAlunoNome) {
                        primeiroAlunoNome = nomeLegivel;
                    }
                }
                
                // 2. Seleciona o primeiro aluno e carrega seus dados
                if (primeiroAlunoNome) {
                    alunoSelecionadoNome = primeiroAlunoNome;
                    selectAluno.value = primeiroAlunoNome;
                    carregarDadosDoAlunoSelecionado();
                }

                // 3. Adiciona o listener de mudan√ßa
                selectAluno.onchange = (e) => {
                    alunoSelecionadoNome = e.target.value;
                    carregarDadosDoAlunoSelecionado();
                };
                
            }, (error) => {
                selectAluno.innerHTML = `<option disabled>Erro ao carregar lista (${error.message})</option>`;
                console.error("Erro ao carregar lista de alunos:", error);
            });
        }
        
        // =================================================================
        // === 2. CARREGAR DADOS DO ALUNO SELECIONADO ===
        // =================================================================

        function carregarDadosDoAlunoSelecionado() {
            if (!alunoSelecionadoNome) return;
            
            // 1. Carrega o treino do aluno selecionado (Dia A por padr√£o)
            carregarTreinoDia();
            
            // 2. Carrega o hist√≥rico de medidas
            carregarHistoricoMedidas();

            // 3. Inicializa o gr√°fico (usaremos o valor do seletor)
            const exercicioInicial = document.getElementById('selectGrafico').value;
            inicializarGraficoAluno(exercicioInicial);
            
            // Atualiza o t√≠tulo
            document.getElementById('titulo-acompanhamento').textContent = `üìä Acompanhamento de ${alunoSelecionadoNome.split(' ')[0]}`;
        }
        
        // =================================================================
        // === 3. EDI√á√ÉO E SALVAMENTO DO TREINO ===
        // =================================================================

        function carregarTreinoDia() {
            const dia = document.getElementById('selectDia').value; // 'A', 'B' ou 'C'
            const editorContainer = document.getElementById('editor-container');
            editorContainer.innerHTML = 'Carregando treino...';
            
            // Caminho: alunos/{nome}/treinoModel/{dia}
            const firebaseRef = database.ref(obterCaminhoAluno('treinoModel') + '/' + dia);

            // Carrega o modelo de treino salvo
            firebaseRef.once('value', (snapshot) => {
                const treinoModel = snapshot.val();
                
                editorContainer.innerHTML = ''; // Limpa
                
                if (treinoModel && Array.isArray(treinoModel)) {
                    // Renderiza os exerc√≠cios existentes
                    treinoModel.forEach(exercicio => {
                        adicionarLinhaExercicio(editorContainer, exercicio.nome, exercicio.series, exercicio.reps);
                    });
                } else {
                    // Se n√£o houver treino, adiciona uma linha vazia padr√£o
                    adicionarLinhaExercicio(editorContainer, '', '', '');
                }
                
                // Adiciona um bot√£o para adicionar mais linhas
                const btnAdd = document.createElement('button');
                btnAdd.textContent = '‚ûï Adicionar Exerc√≠cio';
                btnAdd.onclick = () => adicionarLinhaExercicio(editorContainer, '', '', '');
                btnAdd.style.cssText = 'padding: 8px; margin-top: 10px; background-color: #333; color: white; border: none; border-radius: 4px; cursor: pointer;';
                editorContainer.appendChild(btnAdd);

            }, (error) => {
                editorContainer.innerHTML = `<p style="color: #dc3545;">Erro ao carregar treino: ${error.message}</p>`;
            });
        }

        function adicionarLinhaExercicio(container, nome = '', series = '', reps = '') {
            const row = document.createElement('div');
            row.className = 'treino-row';
            row.innerHTML = `
                <div>
                    <label>Exerc√≠cio</label>
                    <input type="text" class="input-exercicio" value="${nome}" placeholder="Nome do exerc√≠cio">
                </div>
                <div>
                    <label>S√©ries</label>
                    <input type="text" class="input-series" value="${series}" placeholder="Ex: 4">
                </div>
                <div>
                    <label>Reps</label>
                    <input type="text" class="input-reps" value="${reps}" placeholder="Ex: 12">
                </div>
            `;
            // Insere a nova linha antes do bot√£o 'Adicionar Exerc√≠cio' (se ele existir)
            container.insertBefore(row, container.querySelector('button') || null);
        }

        function salvarTreino() {
            if (!alunoSelecionadoNome) {
                alert('Selecione um aluno primeiro.');
                return;
            }

            const dia = document.getElementById('selectDia').value;
            const editorContainer = document.getElementById('editor-container');
            const linhas = editorContainer.querySelectorAll('.treino-row');
            
            const novoTreino = [];
            
            linhas.forEach(linha => {
                const exercicio = linha.querySelector('.input-exercicio').value.trim();
                const series = linha.querySelector('.input-series').value.trim();
                const reps = linha.querySelector('.input-reps').value.trim();

                if (exercicio && series && reps) { // Apenas salva linhas preenchidas
                    novoTreino.push({
                        nome: exercicio,
                        series: series,
                        reps: reps
                    });
                }
            });
            
            if (novoTreino.length === 0) {
                 if (!confirm("Voc√™ est√° salvando um treino vazio. Deseja continuar? Isso apagar√° o treino atual do aluno para este dia.")) {
                    return;
                }
            }

            // Caminho: alunos/{nome}/treinoModel/{dia}
            const firebaseRef = database.ref(obterCaminhoAluno('treinoModel') + '/' + dia);

            firebaseRef.set(novoTreino)
                .then(() => {
                    alert(`‚úÖ Treino ${dia} de ${alunoSelecionadoNome} atualizado e publicado com sucesso!`);
                })
                .catch((error) => {
                    console.error("Erro ao salvar treino:", error);
                    alert(`‚ùå Erro ao salvar treino: ${error.message}`);
                });
        }
        
        // Listener para carregar o treino correto ao mudar o dia
        document.getElementById('selectDia').addEventListener('change', carregarTreinoDia);


        // =================================================================
        // === 4. VISUALIZA√á√ÉO DE DADOS (Medidas e Gr√°fico) ===
        // =================================================================

        function carregarHistoricoMedidas() {
            const tableBody = document.getElementById('tabela-medidas-admin');
            tableBody.innerHTML = '<tr><td colspan="3">Carregando hist√≥rico...</td></tr>';
            
            // Caminho: alunos/{nome}/medidas/ (limita aos 10 √∫ltimos)
            const firebaseRef = database.ref(obterCaminhoAluno('medidas')).limitToLast(10);

            firebaseRef.once('value', (snapshot) => {
                const medidas = snapshot.val();
                tableBody.innerHTML = '';
                
                if (!medidas) {
                    tableBody.innerHTML = '<tr><td colspan="3">Nenhum registro de medidas.</td></tr>';
                    return;
                }

                // Inverte a ordem para mostrar o mais recente primeiro na tabela
                const medidasArray = Object.values(medidas).reverse(); 
                
                medidasArray.forEach(m => {
                    // Adapta√ß√£o: mostra Data, Peso e Cintura
                    const dataCurta = m.data ? m.data.substring(0, 5) : '?'; // DD/MM
                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${dataCurta}</td>
                        <td>${m.pesoCorporal || '?'} kg</td>
                        <td>${m.cintura || '?'} cm</td>
                    `;
                });
            });
        }

        function inicializarGraficoAluno(exercicioKey) {
            if (pesoChart) {
                pesoChart.destroy();
            }
            
            // Caminho: alunos/{nome}/cargas/{exercicioKey}
            const exercicioPath = exercicioKey.replace(/ /g, '_'); // Ex: AgachamentoLivre
            const firebaseRef = database.ref(obterCaminhoAluno('cargas') + exercicioPath);

            firebaseRef.once('value', (snapshot) => {
                const dadosSalvos = [];
                snapshot.forEach(childSnapshot => {
                    dadosSalvos.push(childSnapshot.val());
                });

                const labels = dadosSalvos.map(d => d.data.substring(0, 5)); // DD/MM
                const pesos = dadosSalvos.map(d => d.peso);

                const ctx = document.getElementById('chartAdmin').getContext('2d');
                
                pesoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels.length > 0 ? labels : ['Data'],
                        datasets: [{
                            label: `Carga ${exercicioKey} (kg)`,
                            data: pesos.length > 0 ? pesos : [0],
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            pointBackgroundColor: '#00d4ff',
                            pointBorderColor: '#fff',
                            tension: 0.4,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                title: { display: true, text: 'Carga (kg)', color: '#aaa' }, 
                                ticks: { color: '#aaa' } 
                            },
                            x: { ticks: { color: '#aaa' } }
                        },
                        plugins: { legend: { labels: { color: '#e0e0e0' } } }
                    }
                });
            });
        }


        // =================================================================
        // === INICIALIZA√á√ÉO ===
        // =================================================================

        document.addEventListener('DOMContentLoaded', carregarListaDeAlunos);
    </script>
</body>
</html>
