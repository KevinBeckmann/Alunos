<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Treinador - Admin</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>

    <style>
        /* --- CSS DARK MODE --- */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #121212; /* Fundo escuro */
            color: #e0e0e0;
        }

        h1, h2 { color: #00d4ff; text-align: center; } 
        
        .main-header {
            display: flex; 
            align-items: center; 
            justify-content: center; 
            margin-bottom: 20px;
        }

        .main-header img {
            max-width: 40px; 
            height: auto;
            margin-right: 10px; 
        }

        .main-header h1 {
            margin: 0; 
            color: #00d4ff;
            font-size: 2em; 
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        @media (min-width: 1024px) {
            .container { grid-template-columns: 1fr 2fr; }
        }

        .card {
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        /* --- Estilos do Formul√°rio de Edi√ß√£o --- */
        label { display: block; margin-top: 10px; color: #aaa; font-size: 0.9em; }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            margin-top: 5px;
            background-color: #2c2c2c;
            border: 1px solid #444;
            border-radius: 5px;
            color: white;
            box-sizing: border-box;
        }

        button.btn-save {
            width: 100%;
            padding: 12px;
            margin-top: 20px;
            background-color: #00d4ff;
            color: #000;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.3s;
        }
        button.btn-save:hover { background-color: #00a3cc; }

        /* --- Grid de Inputs do Treino (CORRIGIDO PARA TER 4 COLUNAS) --- */
        .treino-row {
            display: grid;
            /* Garante 4 colunas: Exerc√≠cio, S√©rie, Reps, Bot√£o Remover */
            grid-template-columns: 2fr 1fr 1fr auto; 
            gap: 10px;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #333;
            align-items: end; /* Alinha os itens na base, importante para o bot√£o */
        }
        .btn-remover {
            padding: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            /* Garante que o bot√£o tenha a altura correta */
            height: 40px; 
            margin-bottom: 5px; 
        }


        /* Estilos para a lista de frequ√™ncia */
        #lista-presenca li {
            padding: 5px 0;
            border-bottom: 1px dotted #333;
        }
    </style>
</head>
<body>

    <div class="main-header">
        <img src="LOGOTIPO - Fundo Branco (1).jpg" alt="Logo do Personal" />
        <h1>Painel do Personal</h1>
    </div>

    <div class="container">
        
        <div class="left-col">
            <div class="card">
                <h2>‚úèÔ∏è Editar Treino</h2>
                
                <label>Selecione o Aluno:</label>
                <select id="selectAluno">
                    <option disabled selected>Carregando Alunos...</option>
                </select>

                <label>Dia do Treino:</label>
                <select id="selectDia">
                    <option value="A">Dia A (Peito/Ombro)</option>
                    <option value="B">Dia B (Costas/B√≠ceps)</option>
                    <option value="C">Dia C (Pernas)</option>
                </select>
                
                <hr style="border-color: #333; margin: 20px 0;">

                <div id="editor-container">
                    <p style="color: #aaa;">Selecione um aluno e um dia para carregar o treino.</p>
                </div>

                <button class="btn-save" onclick="salvarTreino()">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>

        <div class="right-col">
            <div class="card">
                <h2 id="titulo-acompanhamento">üìä Acompanhamento do Aluno</h2>
                
                <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
                    <div>
                        <span style="color: #aaa;">Gr√°fico:</span> 
                        <select id="selectGrafico" onchange="inicializarGraficoAluno(this.value)">
                            <option value="AgachamentoLivre">Agachamento Livre</option>
                            <option value="SupinoReto">Supino Reto</option>
                            <option value="PuxadaFrontal">Puxada Frontal</option>
                            <option value="OutroExercicio">Outro Exerc√≠cio (Ajustar)</option>
                        </select>
                    </div>
                </div>

                <div style="height: 300px;">
                    <canvas id="chartAdmin"></canvas>
                </div>
                
                <h3 style="margin-top: 30px; border-top: 1px solid #333; padding-top: 20px;">√öltimas Medidas (Peso e Cintura)</h3>
                <table style="width: 100%; text-align: left; font-size: 0.9em;">
                    <thead>
                        <tr style="color: #aaa;">
                            <th>Data</th>
                            <th>Peso</th>
                            <th>Cintura</th>
                        </tr>
                    </thead>
                    <tbody id="tabela-medidas-admin">
                        <tr><td colspan="3">Nenhum aluno selecionado.</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="card" style="margin-top: 20px;">
                <h2>üìÖ Frequ√™ncia e Presen√ßa</h2>
                <div id="status-frequencia" style="color: #00d4ff; font-weight: bold; margin-bottom: 15px;">
                    Selecione um aluno para ver o hist√≥rico.
                </div>
                <ul id="lista-presenca" style="list-style-type: none; padding: 0;">
                    </ul>
            </div>
        </div>

    </div>

    <script>
        // =================================================================
        // === CONFIGURA√á√ÉO DO FIREBASE (VERIFIQUE E MANTENHA SUAS CHAVES CORRETAS) ===
        // =================================================================
        const firebaseConfig = {
            // As chaves a seguir devem ser as suas chaves corretas e completas
            apiKey: "AIzaSyQDLkdyL4qgoEj1YqBr2xCs0F3aM1o82ef0",
            authDomain: "ptf03-26fdb.firebaseapp.com",
            databaseURL: "https://ptf03-26fdb-default-rtdb.firebaseio.com",
            projectId: "ptf03-26fdb",
            storageBucket: "ptf03-26fdb.firebaseapp.com",
            messagingSenderId: "1020981883676",
            appId: "1:1020981883676:web:7b26aca25ddb1dc02100d9"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        const CAMINHO_ALUNOS = 'alunos/';
        let alunoSelecionadoNome = '';
        let pesoChart; // Vari√°vel global para armazenar a inst√¢ncia do Chart.js

        // =================================================================
        // === AUXILIARES E CONVERS√ÉO DE NOME (CR√çTICO PARA PRECISAO) ===
        // =================================================================

        function formatarNomeParaChave(nome) {
            // Garante que o nome usado para a chave do Firebase seja exatamente o mesmo do painel.
            if (!nome) return '';
            // Se voc√™ usa apenas o primeiro nome como chave no Firebase, modifique esta fun√ß√£o.
            return nome.trim().split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join('_');
        }

        function obterCaminhoAluno(childKey) {
            const nomeFormatado = formatarNomeParaChave(alunoSelecionadoNome); 
            // Exemplo de retorno: 'alunos/Maria_Silva/medidas'
            return `${CAMINHO_ALUNOS}${nomeFormatado}/${childKey}`;
        }

        // =================================================================
        // === FUN√á√ÉO CENTRAL DE SINCRONIZA√á√ÉO (CORRE√á√ÉO DE IMPRECIS√ÉO) ===
        // =================================================================

        function carregarDadosDoAlunoSelecionado() {
            if (!alunoSelecionadoNome) return;
            
            // 1. Recarrega o editor de treino
            carregarTreinoDia();
            
            // 2. Recarrega o hist√≥rico de acompanhamento
            carregarHistoricoMedidas();
            carregarHistoricoPresenca(); 
            
            // 3. Recarrega e redesenha o gr√°fico
            const exercicioInicial = document.getElementById('selectGrafico').value;
            inicializarGraficoAluno(exercicioInicial); 
            
            document.getElementById('titulo-acompanhamento').textContent = `üìä Acompanhamento de ${alunoSelecionadoNome.split(' ')[0]}`;
        }


        // =================================================================
        // === 1. CARREGAR LISTA DE ALUNOS E ATIVAR LISTENERS ===
        // =================================================================

        function carregarListaDeAlunos() {
            const selectAluno = document.getElementById('selectAluno');
            const selectDia = document.getElementById('selectDia');
            selectAluno.innerHTML = '<option disabled selected>Carregando...</option>';

            database.ref(CAMINHO_ALUNOS).once('value', (snapshot) => {
                const todosAlunos = snapshot.val();
                selectAluno.innerHTML = '';
                
                if (!todosAlunos) {
                    selectAluno.innerHTML = '<option disabled selected>Nenhum aluno encontrado.</option>';
                    document.getElementById('editor-container').innerHTML = '<p style="color: #dc3545;">Nenhum aluno registrado no banco de dados no caminho /alunos/.</p>';
                    return;
                }

                let primeiroAlunoNome = null;
                
                for (const nomeAlunoFormatado in todosAlunos) {
                    // Reverte a chave para um nome leg√≠vel: "Maria_Silva" -> "Maria Silva"
                    const nomeLegivel = nomeAlunoFormatado.replace(/_/g, ' '); 
                    
                    const option = document.createElement('option');
                    option.value = nomeLegivel;
                    option.textContent = nomeLegivel;
                    selectAluno.appendChild(option);

                    if (!primeiroAlunoNome) {
                        primeiroAlunoNome = nomeLegivel;
                    }
                }
                
                if (primeiroAlunoNome) {
                    alunoSelecionadoNome = primeiroAlunoNome;
                    selectAluno.value = primeiroAlunoNome;
                    // Carrega dados do primeiro aluno automaticamente
                    carregarDadosDoAlunoSelecionado(); 
                }

                // EVENT LISTENERS (GARANTE A SINCRONIZA√á√ÉO A CADA TROCA)
                selectAluno.onchange = (e) => {
                    alunoSelecionadoNome = e.target.value;
                    carregarDadosDoAlunoSelecionado(); 
                };
                
                selectDia.onchange = carregarTreinoDia; 
                
            }, (error) => {
                selectAluno.innerHTML = `<option disabled>Erro de Conex√£o (${error.code})</option>`;
                console.error("Erro ao carregar lista de alunos:", error);
            });
        }
        
        // =================================================================
        // === 2. EDI√á√ÉO E SALVAMENTO DO TREINO ===
        // =================================================================

        function carregarTreinoDia() {
            const dia = document.getElementById('selectDia').value;
            const editorContainer = document.getElementById('editor-container');
            if (!alunoSelecionadoNome) return; 
            
            editorContainer.innerHTML = 'Carregando treino...';
            
            const firebaseRef = database.ref(obterCaminhoAluno('treinoModel') + '/' + dia);

            firebaseRef.once('value', (snapshot) => {
                const treinoModel = snapshot.val();
                editorContainer.innerHTML = '';
                
                if (treinoModel && Array.isArray(treinoModel)) {
                    treinoModel.forEach(exercicio => {
                        adicionarLinhaExercicio(editorContainer, exercicio.nome, exercicio.series, exercicio.reps);
                    });
                } else {
                     // Adiciona uma linha vazia se o treino for nulo ou inv√°lido
                    adicionarLinhaExercicio(editorContainer, '', '', ''); 
                }
                
                const btnAdd = document.createElement('button');
                btnAdd.textContent = '‚ûï Adicionar Exerc√≠cio';
                // Define a fun√ß√£o de adicionar com uma linha vazia
                btnAdd.onclick = () => adicionarLinhaExercicio(editorContainer, '', '', '');
                btnAdd.style.cssText = 'width: 100%; padding: 8px; margin-top: 10px; background-color: #38c172; color: white; border: none; border-radius: 4px; cursor: pointer;';
                editorContainer.appendChild(btnAdd);

            }, (error) => {
                editorContainer.innerHTML = `<p style="color: #dc3545;">Erro ao carregar treino: ${error.message}</p>`;
            });
        }

        function adicionarLinhaExercicio(container, nome = '', series = '', reps = '') {
            const row = document.createElement('div');
            row.className = 'treino-row';
            row.innerHTML = `
                <div>
                    <label>Exerc√≠cio</label>
                    <input type="text" class="input-exercicio" value="${nome}" placeholder="Nome do exerc√≠cio">
                </div>
                <div>
                    <label>S√©ries</label>
                    <input type="text" class="input-series" value="${series}" placeholder="Ex: 4">
                </div>
                <div>
                    <label>Reps</label>
                    <input type="text" class="input-reps" value="${reps}" placeholder="Ex: 12">
                </div>
                <div>
                    <button type="button" class="btn-remover">X</button>
                </div>
            `;
            // ADI√á√ÉO CR√çTICA: Listener para o bot√£o Remover em cada linha
            row.querySelector('.btn-remover').onclick = () => row.remove();
            
            container.insertBefore(row, container.querySelector('button') || null);
        }

        function salvarTreino() {
            if (!alunoSelecionadoNome) {
                alert('Selecione um aluno primeiro.');
                return;
            }

            const dia = document.getElementById('selectDia').value;
            const linhas = document.getElementById('editor-container').querySelectorAll('.treino-row');
            
            const novoTreino = [];
            
            linhas.forEach(linha => {
                const exercicio = linha.querySelector('.input-exercicio').value.trim();
                const series = linha.querySelector('.input-series').value.trim();
                const reps = linha.querySelector('.input-reps').value.trim();

                // Salva apenas linhas que cont√™m informa√ß√µes de treino v√°lidas
                if (exercicio && series && reps) {
                    novoTreino.push({ nome: exercicio, series: series, reps: reps });
                }
            });
            
            if (novoTreino.length === 0) {
                 if (!confirm("Voc√™ est√° salvando um treino vazio. Deseja continuar?")) {
                     return;
                 }
            }

            const firebaseRef = database.ref(obterCaminhoAluno('treinoModel') + '/' + dia);

            firebaseRef.set(novoTreino)
                .then(() => {
                    alert(`‚úÖ Treino ${dia} de ${alunoSelecionadoNome} atualizado e publicado com sucesso!`);
                })
                .catch((error) => {
                    console.error("Erro ao salvar treino:", error);
                    alert(`‚ùå Erro ao salvar treino: ${error.message}`);
                });
        }
        

        // =================================================================
        // === 3. VISUALIZA√á√ÉO DE DADOS (Medidas e Gr√°fico) ===
        // =================================================================

        function carregarHistoricoMedidas() {
            const tableBody = document.getElementById('tabela-medidas-admin');
            tableBody.innerHTML = '<tr><td colspan="3">Carregando hist√≥rico...</td></tr>';
            
            const firebaseRef = database.ref(obterCaminhoAluno('medidas')).limitToLast(10);

            firebaseRef.once('value', (snapshot) => {
                const medidas = snapshot.val();
                tableBody.innerHTML = '';
                
                if (!medidas) {
                    tableBody.innerHTML = '<tr><td colspan="3">Nenhum registro de medidas.</td></tr>';
                    return;
                }

                // Inverte a ordem para mostrar o registro mais recente no topo
                const medidasArray = Object.values(medidas).reverse(); 
                
                medidasArray.forEach(m => {
                    // Cuidado com a formata√ß√£o de dados!
                    const dataCurta = m.data ? m.data.substring(0, 5).replace(/-/g, '/') : '?'; 
                    const peso = m.pesoCorporal !== undefined ? `${m.pesoCorporal} kg` : '?';
                    const cintura = m.cintura !== undefined ? `${m.cintura} cm` : '?';

                    const row = tableBody.insertRow();
                    row.innerHTML = `
                        <td>${dataCurta}</td>
                        <td>${peso}</td>
                        <td>${cintura}</td>
                    `;
                });
            });
        }

        function inicializarGraficoAluno(exercicioKey) {
            // CORRE√á√ÉO: Destr√≥i a inst√¢ncia anterior do gr√°fico (Essencial para precis√£o)
            if (pesoChart) {
                pesoChart.destroy();
            }
            
            // As chaves no Firebase n√£o devem ter espa√ßos. Ex: "SupinoReto"
            const exercicioPath = exercicioKey.replace(/ /g, '_'); 
            
            // CORRE√á√ÉO DE PATH: Adiciona a barra "/" antes do exerc√≠cio para montar o caminho: cargas/AgachamentoLivre
            const firebaseRef = database.ref(obterCaminhoAluno('cargas') + '/' + exercicioPath); 

            firebaseRef.once('value', (snapshot) => {
                const dadosSalvos = [];
                snapshot.forEach(childSnapshot => {
                    dadosSalvos.push(childSnapshot.val());
                });

                // Verifica se os dados necess√°rios (peso e data) existem e est√£o formatados
                const labels = dadosSalvos.map(d => d && d.data ? d.data.substring(0, 5) : ''); 
                const pesos = dadosSalvos.map(d => d && d.peso !== undefined ? d.peso : 0); 
                
                const ctx = document.getElementById('chartAdmin').getContext('2d');
                
                pesoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        // Se n√£o houver dados de peso v√°lidos, use r√≥tulos e dados de fallback
                        labels: labels.length > 0 && pesos.some(p => p > 0) ? labels : ['Sem Dados'],
                        datasets: [{
                            label: `Carga ${exercicioKey} (kg)`,
                            data: pesos.length > 0 ? pesos : [0],
                            borderColor: '#00d4ff',
                            backgroundColor: 'rgba(0, 212, 255, 0.1)',
                            pointBackgroundColor: '#00d4ff',
                            pointBorderColor: '#fff',
                            tension: 0.4,
                            fill: true,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        scales: {
                            y: { 
                                beginAtZero: true,
                                title: { display: true, text: 'Carga (kg)', color: '#aaa' }, 
                                ticks: { color: '#aaa' } 
                            },
                            x: { ticks: { color: '#aaa' } }
                        },
                        plugins: { legend: { labels: { color: '#e0e0e0' } } }
                    }
                });
            });
        }
        
        // =================================================================
        // === 4. CARREGAR FREQU√äNCIA ===
        // =================================================================

        function carregarHistoricoPresenca() {
            const listaPresenca = document.getElementById('lista-presenca');
            const statusDiv = document.getElementById('status-frequencia');
            listaPresenca.innerHTML = '';
            statusDiv.textContent = 'Carregando frequ√™ncia...';
            
            if (!alunoSelecionadoNome) {
                statusDiv.textContent = 'Selecione um aluno para ver o hist√≥rico.';
                return;
            }
            
            const firebaseRef = database.ref(obterCaminhoAluno('presenca'));

            firebaseRef.once('value', (snapshot) => {
                const presenca = snapshot.val();
                
                if (!presenca) {
                    statusDiv.textContent = '‚ö†Ô∏è Nenhum registro de presen√ßa encontrado.';
                    return;
                }

                // Obt√©m as chaves (datas) e inverte a ordem para mostrar as mais recentes primeiro
                const datas = Object.keys(presenca).reverse(); 
                
                statusDiv.textContent = `‚úÖ Total de Presen√ßas Registradas: ${datas.length} vezes`;
                
                datas.forEach(chaveData => {
                    // A data √© salva como chave YYYY-MM-DD
                    const dataLegivel = chaveData.replace(/-/g, '/'); 
                    
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <span style="display: flex; justify-content: space-between;">
                            <span>‚úÖ Data:</span> <span>${dataLegivel}</span>
                        </span>
                    `;
                    listaPresenca.appendChild(li);
                });

            });
        }


        // =================================================================
        // === INICIALIZA√á√ÉO ===
        // =================================================================

        document.addEventListener('DOMContentLoaded', carregarListaDeAlunos);
    </script>
</body>
</html>
