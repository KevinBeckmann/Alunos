<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Treinador - Admin</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-auth-compat.js"></script>

    <style>
        /* ESTILOS COMPLETOS */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 20px; background-color: #121212; color: #e0e0e0; }
        
        /* Login */
        #login-screen {
            max-width: 400px; margin: 100px auto; padding: 30px; background-color: #1e1e1e;
            border-radius: 10px; border: 1px solid #333; text-align: center;
        }
        #login-screen h2 { color: #00d4ff; margin-bottom: 20px; }
        #login-screen input { width: 100%; padding: 10px; margin-bottom: 15px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 5px; }
        #login-screen button { width: 100%; padding: 12px; background: #00d4ff; color: #000; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #login-erro { color: #dc3545; margin-top: 10px; }
        
        /* Cabe√ßalho */
        .main-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .main-header h1 { color: #00d4ff; margin: 0; }
        
        /* Abas */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; background: #2c2c2c; border: 1px solid #333; border-radius: 5px; color: #e0e0e0; cursor: pointer; }
        .tab-btn.active { background: #00d4ff; color: #000; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        /* Container principal */
        .container { max-width: 1200px; margin: 0 auto; display: grid; gap: 20px; grid-template-columns: 1fr; }
        @media (min-width: 1024px) { .container { grid-template-columns: 1fr 2fr; } }
        
        /* Cards */
        .card { background: #1e1e1e; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 20px; }
        
        /* Formul√°rios */
        input, select, textarea { width: 100%; padding: 10px; margin-top: 5px; background: #2c2c2c; border: 1px solid #444; color: white; border-radius: 5px; }
        
        /* Bot√µes */
        button { cursor: pointer; }
        .btn-save { width: 100%; padding: 12px; background: #00d4ff; color: #000; border: none; border-radius: 5px; font-weight: bold; margin-top: 10px; }
        .btn-success { background: #38c172; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #000; }
        
        /* Editor de treino */
        .treino-row { 
            display: grid; 
            grid-template-columns: 2fr 1fr 1fr auto auto; 
            gap: 10px; 
            margin-bottom: 10px; 
            padding-bottom: 10px; 
            border-bottom: 1px dashed #333; 
            align-items: end;
        }
        .handle-drag { cursor: move; text-align: center; padding: 10px; color: #aaa; }
        .btn-remover { padding: 10px; background: #dc3545; color: white; border: none; border-radius: 5px; }
        
        /* Preview aluno */
        #preview-aluno { background: #2c2c2c; padding: 15px; border-radius: 8px; min-height: 200px; }
        
        /* Hist√≥rico */
        #historico-envios { list-style: none; padding: 0; }
        #historico-envios li { padding: 10px; border-bottom: 1px solid #333; }
        
        /* Mensagens */
        .mensagem { padding: 10px; margin: 10px 0; border-radius: 5px; text-align: center; }
        .sucesso { background: #38c172; color: white; }
        .erro { background: #dc3545; color: white; }
        
        /* Modais */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; }
        .modal-content { background: #1e1e1e; margin: 50px auto; padding: 20px; border-radius: 10px; max-width: 500px; position: relative; }
        .close { position: absolute; right: 15px; top: 10px; color: #aaa; font-size: 24px; cursor: pointer; }
        
        /* Grupo de bot√µes */
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-group button { flex: 1; }
        
        /* Tabelas */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #333; }
        th { color: #aaa; }
    </style>
</head>
<body>

    <!-- Tela de Login -->
    <div id="login-screen" style="display:none;">
        <h2>Acesso Restrito - Painel do Professor</h2>
        <input type="email" id="login-email" placeholder="E-mail" required>
        <input type="password" id="login-senha" placeholder="Senha" required>
        <button onclick="fazerLogin()">Entrar</button>
        <p id="login-erro"></p>
    </div>

    <!-- Conte√∫do Principal -->
    <div id="main-content" style="display:none;">
        <div class="main-header">
            <h1>Painel do Professor</h1>
            <button onclick="fazerLogout()" class="btn-danger" style="padding: 10px 20px;">Sair</button>
        </div>

        <!-- Abas -->
        <div class="tabs">
            <button class="tab-btn active" onclick="abrirTab('tab-treino')">üìã Treino</button>
            <button class="tab-btn" onclick="abrirTab('tab-graficos')">üìä Gr√°ficos</button>
            <button class="tab-btn" onclick="abrirTab('tab-sessoes')">üìÖ Sess√µes</button>
            <button class="tab-btn" onclick="abrirTab('tab-medidas')">üìè Medidas</button>
        </div>

        <!-- Aba Treino -->
        <div id="tab-treino" class="tab-content active">
            <div class="container">
                <!-- Coluna Esquerda -->
                <div class="left-col">
                    <div class="card">
                        <h2>Gest√£o de Alunos</h2>
                        <button onclick="abrirModalAluno()" class="btn-success">+ Adicionar Aluno</button>
                    </div>
                    
                    <div class="card">
                        <h2>Editar Treino</h2>
                        
                        <label>Selecione o Aluno:</label>
                        <select id="selectAluno" onchange="selecionarAluno(this.value)">
                            <option>Carregando...</option>
                        </select>
                        
                        <div class="btn-group">
                            <button onclick="abrirModalRenomearAluno()" class="btn-warning">‚úèÔ∏è Renomear</button>
                            <button onclick="excluirAluno()" class="btn-danger">üóëÔ∏è Excluir</button>
                        </div>
                        
                        <label style="margin-top: 20px;">Dia do Treino:</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="selectDia" onchange="carregarTreinoDia()" style="flex: 1;">
                                <option>Carregando...</option>
                            </select>
                            <button onclick="abrirModalDia()" class="btn-success" style="width: 40px;">+</button>
                            <button onclick="removerDiaTreino()" class="btn-danger" style="width: 40px;">-</button>
                        </div>
                        
                        <div id="mensagem-treino" class="mensagem" style="display:none;"></div>
                        
                        <div id="editor-container" style="margin-top: 20px;">
                            <!-- Exerc√≠cios ser√£o carregados aqui -->
                        </div>
                        
                        <button onclick="addLinha()" class="btn-success">+ Adicionar Exerc√≠cio</button>
                        
                        <div class="btn-group" style="margin-top: 20px;">
                            <button onclick="salvarTreino()" class="btn-save">üíæ Salvar Treino</button>
                            <button onclick="enviarTreinoParaAluno()" class="btn-success">üöÄ Enviar para Aluno</button>
                        </div>
                    </div>
                </div>
                
                <!-- Coluna Direita -->
                <div class="right-col">
                    <div class="card">
                        <h2>Visualiza√ß√£o do Aluno</h2>
                        <div id="preview-aluno">
                            <p style="text-align: center; color: #777;">Selecione um aluno</p>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>Hist√≥rico de Envios</h2>
                        <ul id="historico-envios">
                            <li>Nenhum envio registrado</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba Gr√°ficos -->
        <div id="tab-graficos" class="tab-content">
            <div class="card">
                <h2>üìä Gr√°ficos do Aluno</h2>
                <select id="selectAlunoGraficos" onchange="selecionarAluno(this.value)">
                    <option>Carregando...</option>
                </select>
                <div id="graficos-container" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Aba Sess√µes -->
        <div id="tab-sessoes" class="tab-content">
            <div class="card">
                <h2>üìÖ Sess√µes</h2>
                <select id="selectAlunoSessoes" onchange="selecionarAluno(this.value)">
                    <option>Carregando...</option>
                </select>
                <button onclick="abrirModalSessao()" class="btn-success" style="margin-top: 10px;">+ Nova Sess√£o</button>
                <div id="lista-sessoes" style="margin-top: 20px;"></div>
            </div>
        </div>

        <!-- Aba Medidas -->
        <div id="tab-medidas" class="tab-content">
            <div class="card">
                <h2>üìè Medidas</h2>
                <select id="selectAlunoMedidas" onchange="selecionarAluno(this.value)">
                    <option>Carregando...</option>
                </select>
                <button onclick="abrirModalMedida()" class="btn-success" style="margin-top: 10px;">+ Nova Medida</button>
                <table id="tabela-medidas">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Peso (kg)</th>
                            <th>Cintura (cm)</th>
                            <th>Bra√ßo (cm)</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="5" style="text-align: center;">Nenhuma medida</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="modalAluno" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalAluno')">&times;</span>
            <h2>Adicionar Aluno</h2>
            <input type="text" id="aluno-nome" placeholder="Nome do Aluno">
            <input type="email" id="aluno-email" placeholder="E-mail">
            <button onclick="salvarAluno()" class="btn-save">Salvar</button>
        </div>
    </div>

    <div id="modalDia" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalDia')">&times;</span>
            <h2>Novo Dia de Treino</h2>
            <input type="text" id="dia-nome" placeholder="Ex: Dia A">
            <button onclick="salvarNovoDia()" class="btn-save">Criar</button>
        </div>
    </div>

    <div id="modalSessao" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalSessao')">&times;</span>
            <h2>Nova Sess√£o</h2>
            <input type="date" id="sessao-data">
            <select id="sessao-tipo">
                <option value="A">Treino A</option>
                <option value="B">Treino B</option>
                <option value="C">Treino C</option>
                <option value="D">Treino D</option>
            </select>
            <textarea id="sessao-obs" placeholder="Observa√ß√µes"></textarea>
            <button onclick="salvarSessao()" class="btn-save">Salvar</button>
        </div>
    </div>

    <div id="modalMedida" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalMedida')">&times;</span>
            <h2>Nova Medida</h2>
            <input type="date" id="medida-data">
            <input type="number" id="medida-peso" placeholder="Peso (kg)" step="0.1">
            <input type="number" id="medida-cintura" placeholder="Cintura (cm)" step="0.1">
            <input type="number" id="medida-braco" placeholder="Bra√ßo (cm)" step="0.1">
            <button onclick="salvarMedida()" class="btn-save">Salvar</button>
        </div>
    </div>

    <div id="modalRenomearAluno" class="modal">
        <div class="modal-content">
            <span class="close" onclick="fecharModal('modalRenomearAluno')">&times;</span>
            <h2>Renomear Aluno</h2>
            <p>Aluno atual: <strong id="nome-atual-aluno"></strong></p>
            <input type="text" id="novo-nome-aluno" placeholder="Novo nome">
            <button onclick="renomearAluno()" class="btn-save">Renomear</button>
        </div>
    </div>

    <script>
        // Configura√ß√£o Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDlKdyL4QgpEj1YqBr2xCs0F3aM1o82ef0",
            authDomain: "ptf03-26fdb.firebaseapp.com",
            databaseURL: "https://ptf03-26fdb-default-rtdb.firebaseio.com",
            projectId: "ptf03-26fdb",
            storageBucket: "ptf03-26fdb.firebasestorage.app",
            messagingSenderId: "1020981883676",
            appId: "1:1020981883676:web:7b26aca25ddb1dc02100d9"
        };
        
        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        
        // Vari√°veis globais
        let alunoSelecionadoNome = '';
        let alunoSelecionadoChave = '';
        let editorSortable = null;
        let graficos = {};

        // ========== FUN√á√ïES GERAIS ==========
        function formatarNomeParaChave(nome) {
            return nome.trim()
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
                .replace(/[^a-zA-Z0-9\s]/g, '')
                .replace(/\s+/g, '_')
                .toLowerCase();
        }

        function getPath(sub) {
            return `alunos/${alunoSelecionadoChave}/${sub}`;
        }

        function mostrarMensagem(texto, tipo = 'sucesso', elemento = 'mensagem-treino') {
            const div = document.getElementById(elemento);
            div.textContent = texto;
            div.className = `mensagem ${tipo}`;
            div.style.display = 'block';
            setTimeout(() => div.style.display = 'none', 3000);
        }

        function fecharModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ========== AUTENTICA√á√ÉO ==========
        function iniciarObservadorAuth() {
            auth.onAuthStateChanged((user) => {
                const login = document.getElementById('login-screen');
                const main = document.getElementById('main-content');
                
                if (user) {
                    login.style.display = 'none';
                    main.style.display = 'block';
                    inicializarPainel();
                } else {
                    login.style.display = 'block';
                    main.style.display = 'none';
                }
            });
        }

        function fazerLogin() {
            const email = document.getElementById('login-email').value;
            const senha = document.getElementById('login-senha').value;
            
            auth.signInWithEmailAndPassword(email, senha)
                .catch((error) => {
                    document.getElementById('login-erro').textContent = error.message;
                });
        }

        function fazerLogout() {
            auth.signOut();
        }

        // ========== INICIALIZA√á√ÉO ==========
        function inicializarPainel() {
            // Configurar selects
            const selects = [
                'selectAluno',
                'selectAlunoGraficos',
                'selectAlunoSessoes',
                'selectAlunoMedidas'
            ];
            
            selects.forEach(id => {
                document.getElementById(id).onchange = function() {
                    selecionarAluno(this.value);
                };
            });
            
            carregarListaAlunos();
        }

        function selecionarAluno(nome) {
            alunoSelecionadoNome = nome;
            alunoSelecionadoChave = formatarNomeParaChave(nome);
            
            // Atualizar todos os selects
            ['selectAluno', 'selectAlunoGraficos', 'selectAlunoSessoes', 'selectAlunoMedidas'].forEach(id => {
                document.getElementById(id).value = nome;
            });
            
            // Carregar dados do aluno selecionado
            const tabAtiva = document.querySelector('.tab-content.active').id;
            if (tabAtiva === 'tab-treino') {
                carregarDiasTreinoDoAluno();
                carregarTreinoAtualAluno();
                carregarHistoricoEnvios();
            } else if (tabAtiva === 'tab-graficos') {
                carregarGraficosAluno();
            } else if (tabAtiva === 'tab-sessoes') {
                carregarSessoesAluno();
            } else if (tabAtiva === 'tab-medidas') {
                carregarMedidasCompletas();
            }
        }

        function carregarListaAlunos() {
            database.ref('alunos').once('value').then(snap => {
                const alunos = snap.val();
                const selects = [
                    'selectAluno',
                    'selectAlunoGraficos', 
                    'selectAlunoSessoes',
                    'selectAlunoMedidas'
                ];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">Selecione um aluno</option>';
                    
                    if (alunos) {
                        for (const chave in alunos) {
                            const nome = alunos[chave].info?.nome || chave.replace(/_/g, ' ');
                            const option = document.createElement('option');
                            option.value = nome;
                            option.textContent = nome;
                            select.appendChild(option);
                        }
                    }
                });
                
                // Selecionar primeiro aluno se existir
                if (alunos && !alunoSelecionadoNome) {
                    const primeiro = Object.keys(alunos)[0];
                    if (primeiro) {
                        const nome = alunos[primeiro].info?.nome || primeiro.replace(/_/g, ' ');
                        selecionarAluno(nome);
                    }
                }
            });
        }

        // ========== ABA TREINO ==========
        function carregarDiasTreinoDoAluno() {
            if (!alunoSelecionadoChave) return;
            
            const select = document.getElementById('selectDia');
            select.innerHTML = '<option>Carregando...</option>';
            
            database.ref(getPath('treinoModel')).once('value').then(snap => {
                const dias = snap.val();
                select.innerHTML = '';
                
                if (dias) {
                    Object.keys(dias).forEach(dia => {
                        const option = document.createElement('option');
                        option.value = dia;
                        option.textContent = dia;
                        select.appendChild(option);
                    });
                }
                
                if (select.options.length > 0) {
                    select.value = select.options[0].value;
                    carregarTreinoDia();
                } else {
                    select.innerHTML = '<option value="">Nenhum dia criado</option>';
                }
            });
        }

        function carregarTreinoDia() {
            const dia = document.getElementById('selectDia').value;
            if (!dia || !alunoSelecionadoChave) return;
            
            const container = document.getElementById('editor-container');
            container.innerHTML = '<p>Carregando...</p>';
            
            database.ref(getPath(`treinoModel/${dia}`)).once('value').then(snap => {
                const treino = snap.val();
                container.innerHTML = '';
                
                // Destruir Sortable anterior
                if (editorSortable) {
                    editorSortable.destroy();
                }
                
                // Adicionar exerc√≠cios
                if (treino && Array.isArray(treino)) {
                    treino.forEach(exercicio => {
                        addLinha(exercicio.nome, exercicio.series, exercicio.reps, true);
                    });
                }
                
                // Adicionar uma linha vazia se n√£o houver exerc√≠cios
                if (!treino || treino.length === 0) {
                    addLinha('', '', '', true);
                }
                
                // Inicializar Sortable
                initSortable();
            });
        }

        function addLinha(nome = '', series = '', reps = '', isInitialLoad = false) {
            const container = document.getElementById('editor-container');
            const div = document.createElement('div');
            div.className = 'treino-row';
            div.innerHTML = `
                <div>
                    <input type="text" value="${nome}" placeholder="Exerc√≠cio" class="exercicio-nome">
                </div>
                <div>
                    <input type="text" value="${series}" placeholder="S√©ries" class="exercicio-series">
                </div>
                <div>
                    <input type="text" value="${reps}" placeholder="Repeti√ß√µes" class="exercicio-reps">
                </div>
                <div class="handle-drag">‚ò∞</div>
                <div>
                    <button class="btn-remover" onclick="this.parentElement.parentElement.remove()">X</button>
                </div>
            `;
            
            container.appendChild(div);
        }

        function initSortable() {
            const container = document.getElementById('editor-container');
            editorSortable = Sortable.create(container, {
                handle: '.handle-drag',
                animation: 150,
                ghostClass: 'sortable-ghost'
            });
        }

        function salvarTreino() {
            if (!alunoSelecionadoChave) {
                mostrarMensagem('Selecione um aluno!', 'erro');
                return;
            }
            
            const dia = document.getElementById('selectDia').value;
            if (!dia) {
                mostrarMensagem('Selecione um dia!', 'erro');
                return;
            }
            
            const linhas = document.querySelectorAll('.treino-row');
            const exercicios = [];
            
            linhas.forEach(linha => {
                const nome = linha.querySelector('.exercicio-nome').value.trim();
                const series = linha.querySelector('.exercicio-series').value.trim();
                const reps = linha.querySelector('.exercicio-reps').value.trim();
                
                if (nome) {
                    exercicios.push({ nome, series, reps });
                }
            });
            
            if (exercicios.length === 0) {
                mostrarMensagem('Adicione pelo menos um exerc√≠cio!', 'erro');
                return;
            }
            
            database.ref(getPath(`treinoModel/${dia}`)).set(exercicios)
                .then(() => mostrarMensagem('Treino salvo com sucesso!', 'sucesso'))
                .catch(err => mostrarMensagem('Erro: ' + err.message, 'erro'));
        }

        function enviarTreinoParaAluno() {
            if (!alunoSelecionadoChave) {
                mostrarMensagem('Selecione um aluno!', 'erro');
                return;
            }
            
            const dia = document.getElementById('selectDia').value;
            if (!dia) {
                mostrarMensagem('Selecione um dia!', 'erro');
                return;
            }
            
            // Primeiro salvar o treino
            salvarTreino();
            
            // Depois enviar para o aluno
            database.ref(getPath(`treinoModel/${dia}`)).once('value').then(snap => {
                const treino = snap.val();
                
                if (!treino) {
                    mostrarMensagem('Primeiro crie o treino!', 'erro');
                    return;
                }
                
                const treinoFormatado = {
                    data: new Date().toISOString().split('T')[0],
                    dia: dia,
                    exercicios: treino.map(ex => ({
                        ...ex,
                        concluido: false,
                        carga: '',
                        observacoes: ''
                    })),
                    enviadoPor: auth.currentUser.email,
                    timestamp: Date.now()
                };
                
                // Salvar em treinoDiaAtual
                database.ref(getPath('treinoDiaAtual')).set(treinoFormatado)
                    .then(() => {
                        // Salvar no hist√≥rico
                        const historicoRef = database.ref(getPath('historicoEnvios')).push();
                        historicoRef.set({
                            ...treinoFormatado,
                            exerciciosCount: treino.length
                        });
                        
                        mostrarMensagem('Treino enviado para o aluno!', 'sucesso');
                        carregarTreinoAtualAluno();
                        carregarHistoricoEnvios();
                    })
                    .catch(err => mostrarMensagem('Erro ao enviar: ' + err.message, 'erro'));
            });
        }

        function carregarTreinoAtualAluno() {
            if (!alunoSelecionadoChave) return;
            
            database.ref(getPath('treinoDiaAtual')).once('value').then(snap => {
                const treino = snap.val();
                const preview = document.getElementById('preview-aluno');
                
                if (!treino) {
                    preview.innerHTML = '<p style="text-align: center;">Nenhum treino enviado</p>';
                    return;
                }
                
                let html = `
                    <h3>Treino Atual</h3>
                    <p><strong>Dia:</strong> ${treino.dia}</p>
                    <p><strong>Data:</strong> ${treino.data}</p>
                    <hr>
                `;
                
                if (treino.exercicios && Array.isArray(treino.exercicios)) {
                    treino.exercicios.forEach((ex, i) => {
                        html += `
                            <div style="margin-bottom: 10px; padding: 10px; background: #2c2c2c; border-radius: 5px;">
                                <strong>${i+1}. ${ex.nome}</strong><br>
                                <small>${ex.series} s√©ries x ${ex.reps} reps</small>
                                ${ex.concluido ? '<br><small>‚úÖ Conclu√≠do</small>' : ''}
                            </div>
                        `;
                    });
                }
                
                preview.innerHTML = html;
            });
        }

        function carregarHistoricoEnvios() {
            if (!alunoSelecionadoChave) return;
            
            database.ref(getPath('historicoEnvios')).orderByChild('timestamp').limitToLast(5).once('value').then(snap => {
                const historico = document.getElementById('historico-envios');
                historico.innerHTML = '';
                
                if (!snap.exists()) {
                    historico.innerHTML = '<li>Nenhum envio registrado</li>';
                    return;
                }
                
                snap.forEach(child => {
                    const envio = child.val();
                    const li = document.createElement('li');
                    li.innerHTML = `
                        <strong>${new Date(envio.timestamp).toLocaleDateString()}</strong><br>
                        ${envio.dia} - ${envio.exerciciosCount} exerc√≠cios
                    `;
                    historico.appendChild(li);
                });
            });
        }

        // ========== DIAS DE TREINO ==========
        function abrirModalDia() {
            document.getElementById('dia-nome').value = '';
            document.getElementById('modalDia').style.display = 'block';
        }

        function salvarNovoDia() {
            const nomeDia = document.getElementById('dia-nome').value.trim();
            if (!nomeDia) {
                alert('Digite o nome do dia!');
                return;
            }
            
            if (!alunoSelecionadoChave) {
                alert('Selecione um aluno primeiro!');
                return;
            }
            
            database.ref(getPath(`treinoModel/${nomeDia}`)).set([])
                .then(() => {
                    fecharModal('modalDia');
                    carregarDiasTreinoDoAluno();
                    document.getElementById('selectDia').value = nomeDia;
                    carregarTreinoDia();
                    mostrarMensagem('Dia criado com sucesso!', 'sucesso');
                })
                .catch(err => alert('Erro: ' + err.message));
        }

        function removerDiaTreino() {
            const dia = document.getElementById('selectDia').value;
            if (!dia || !alunoSelecionadoChave) {
                alert('Selecione um dia para remover!');
                return;
            }
            
            if (confirm(`Remover o dia "${dia}"?`)) {
                database.ref(getPath(`treinoModel/${dia}`)).remove()
                    .then(() => {
                        carregarDiasTreinoDoAluno();
                        mostrarMensagem('Dia removido!', 'sucesso');
                    })
                    .catch(err => alert('Erro: ' + err.message));
            }
        }

        // ========== GERENCIAR ALUNOS ==========
        function abrirModalAluno() {
            document.getElementById('aluno-nome').value = '';
            document.getElementById('aluno-email').value = '';
            document.getElementById('modalAluno').style.display = 'block';
        }

        function salvarAluno() {
            const nome = document.getElementById('aluno-nome').value.trim();
            const email = document.getElementById('aluno-email').value.trim();
            const chave = formatarNomeParaChave(nome);
            
            if (!nome || !email) {
                alert('Preencha todos os campos!');
                return;
            }
            
            database.ref(`alunos/${chave}/info`).set({
                nome: nome,
                email: email,
                criadoEm: Date.now()
            })
            .then(() => {
                fecharModal('modalAluno');
                carregarListaAlunos();
                selecionarAluno(nome);
                mostrarMensagem('Aluno criado com sucesso!', 'sucesso');
            })
            .catch(err => alert('Erro: ' + err.message));
        }

        function abrirModalRenomearAluno() {
            if (!alunoSelecionadoNome) {
                alert('Selecione um aluno primeiro!');
                return;
            }
            
            document.getElementById('nome-atual-aluno').textContent = alunoSelecionadoNome;
            document.getElementById('novo-nome-aluno').value = alunoSelecionadoNome;
            document.getElementById('modalRenomearAluno').style.display = 'block';
        }

        function renomearAluno() {
            const novoNome = document.getElementById('novo-nome-aluno').value.trim();
            if (!novoNome || novoNome === alunoSelecionadoNome) {
                alert('Digite um novo nome diferente!');
                return;
            }
            
            const novaChave = formatarNomeParaChave(novoNome);
            const chaveAtual = alunoSelecionadoChave;
            
            // Verificar se j√° existe aluno com o novo nome
            database.ref(`alunos/${novaChave}`).once('value').then(snap => {
                if (snap.exists()) {
                    alert('J√° existe um aluno com este nome!');
                    return;
                }
                
                // Copiar dados para nova chave
                database.ref(`alunos/${chaveAtual}`).once('value').then(snap => {
                    const dados = snap.val();
                    dados.info.nome = novoNome;
                    
                    // Salvar na nova chave
                    return database.ref(`alunos/${novaChave}`).set(dados)
                        .then(() => database.ref(`alunos/${chaveAtual}`).remove());
                })
                .then(() => {
                    fecharModal('modalRenomearAluno');
                    carregarListaAlunos();
                    selecionarAluno(novoNome);
                    mostrarMensagem('Aluno renomeado com sucesso!', 'sucesso');
                });
            })
            .catch(err => alert('Erro: ' + err.message));
        }

        function excluirAluno() {
            if (!alunoSelecionadoNome) {
                alert('Selecione um aluno primeiro!');
                return;
            }
            
            if (confirm(`Excluir o aluno "${alunoSelecionadoNome}" e todos os seus dados?`)) {
                database.ref(`alunos/${alunoSelecionadoChave}`).remove()
                    .then(() => {
                        alunoSelecionadoNome = '';
                        alunoSelecionadoChave = '';
                        carregarListaAlunos();
                        mostrarMensagem('Aluno exclu√≠do!', 'sucesso');
                    })
                    .catch(err => alert('Erro: ' + err.message));
            }
        }

        // ========== NAVEGA√á√ÉO ENTRE ABAS ==========
        function abrirTab(tabId) {
            // Remover classe active de todas as abas
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Adicionar classe active na aba clicada
            document.querySelector(`.tab-btn[onclick="abrirTab('${tabId}')"]`).classList.add('active');
            document.getElementById(tabId).classList.add('active');
            
            // Carregar dados da aba se houver aluno selecionado
            if (alunoSelecionadoChave) {
                if (tabId === 'tab-treino') {
                    carregarDiasTreinoDoAluno();
                    carregarTreinoAtualAluno();
                    carregarHistoricoEnvios();
                } else if (tabId === 'tab-graficos') {
                    carregarGraficosAluno();
                } else if (tabId === 'tab-sessoes') {
                    carregarSessoesAluno();
                } else if (tabId === 'tab-medidas') {
                    carregarMedidasCompletas();
                }
            }
        }

        // ========== ABA GR√ÅFICOS ==========
        function carregarGraficosAluno() {
            if (!alunoSelecionadoChave) return;
            
            const container = document.getElementById('graficos-container');
            container.innerHTML = '<p>Carregando gr√°ficos...</p>';
            
            // Implementar gr√°ficos aqui
            container.innerHTML = '<p>Gr√°ficos ser√£o implementados em breve...</p>';
        }

        // ========== ABA SESS√ïES ==========
        function carregarSessoesAluno() {
            if (!alunoSelecionadoChave) return;
            
            const container = document.getElementById('lista-sessoes');
            container.innerHTML = '<p>Carregando sess√µes...</p>';
            
            // Implementar sess√µes aqui
            container.innerHTML = '<p>Sess√µes ser√£o implementadas em breve...</p>';
        }

        function abrirModalSessao() {
            if (!alunoSelecionadoChave) {
                alert('Selecione um aluno primeiro!');
                return;
            }
            document.getElementById('sessao-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('modalSessao').style.display = 'block';
        }

        function salvarSessao() {
            // Implementar salvar sess√£o
            alert('Funcionalidade em desenvolvimento!');
        }

        // ========== ABA MEDIDAS ==========
        function carregarMedidasCompletas() {
            if (!alunoSelecionadoChave) return;
            
            const tbody = document.querySelector('#tabela-medidas tbody');
            tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
            
            // Implementar medidas aqui
            tbody.innerHTML = '<tr><td colspan="5">Medidas ser√£o implementadas em breve...</td></tr>';
        }

        function abrirModalMedida() {
            if (!alunoSelecionadoChave) {
                alert('Selecione um aluno primeiro!');
                return;
            }
            document.getElementById('medida-data').value = new Date().toISOString().split('T')[0];
            document.getElementById('modalMedida').style.display = 'block';
        }

        function salvarMedida() {
            // Implementar salvar medida
            alert('Funcionalidade em desenvolvimento!');
        }

        // ========== INICIAR APLICA√á√ÉO ==========
        // Iniciar observador de autentica√ß√£o quando a p√°gina carregar
        window.addEventListener('DOMContentLoaded', () => {
            iniciarObservadorAuth();
        });
    </script>
</body>
</html>
