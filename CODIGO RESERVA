<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Meta tags PWA adicionadas para instalabilidade -->
    <meta name="theme-color" content="#000000">
    <meta name="description" content="Dashboard do Aluno - Acompanhe seu treino, medidas e progresso">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Dashboard Aluno">
    
    <!-- Link para o manifest.json -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Ícones para dispositivos Apple -->
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png">
    
    <title>Dashboard do Aluno - Dark Mode</title>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.1.0/firebase-database-compat.js"></script>

    <style>
        /* --- ESTILOS GERAIS --- */
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #000000;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        nav {
            width: 100%;
            max-width: 1200px;
            text-align: right;
            margin-bottom: 10px;
        }

        nav a {
            color: #ff8c00;
            text-decoration: none;
            font-size: 0.9em;
        }

        /* HEADER */
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
            gap: 20px;
            text-align: center;
            max-width: 100%;
        }

        .header-content img {
            max-width: 80px;
            height: auto;
            border-radius: 10px;
        }

        .header-content h1 {
            color: #ff8c00;
            margin: 0;
            font-size: 2.2em;
            line-height: 1.2;
        }

        /* LAYOUT RESPONSIVO (GRID) */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            gap: 20px;
            width: 100%;
            justify-content: center;
            grid-template-columns: 1fr;
        }

        @media (min-width: 768px) {
            .container {
                grid-template-columns: 1fr 1fr;
            }
            #chart-card {
                grid-column: 1 / 3;
                order: 1;
            }
        }

        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 1fr 1fr 1fr;
            }
            #chart-card {
                grid-column: auto;
                order: initial;
            }
        }

        /* CARDS */
        .card {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        #medidas-card {
            order: 2;
        }

        /* CARD DE TREINO COM BORDA IGUAL AO PRINT */
        #treino-card {
            border: 2px solid #ff8c00;
            box-shadow: 0 0 12px rgba(255, 140, 0, 0.7);
            border-radius: 14px;
            background-color: #111;
        }

        #treino-card h2 {
            color: #ffb733;
            text-align: center;
            margin-top: 0;
        }

        /* FORMULÁRIOS E INPUTS */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            justify-content: space-between;
        }

        .input-group label {
            width: 95px;
            flex-shrink: 0;
            font-size: 0.9em;
            color: #ccc;
        }

        #medidas-card .input-container {
            max-width: 350px;
            margin: 0 auto 15px auto;
        }

        #medidas-card .input-group {
            width: 100%;
        }

        .input-group input,
        select {
            flex-grow: 1;
            padding: 8px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #f0f0f0;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }

        select {
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23ff9933" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 30px;
        }

        select option {
            background-color: #1a1a1a;
        }

        h2 {
            color: #ff9933;
            margin-top: 0;
            margin-bottom: 15px;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
        }

        /* LISTA DE TREINO */
        .exercicio-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .exercicio-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .exercicio-info strong {
            font-size: 1.1em;
            display: block;
            margin-bottom: 5px;
        }

        .checkbox-container input[type="checkbox"] {
            transform: scale(1.3);
            cursor: pointer;
        }

        .concluido {
            background-color: #387038;
            opacity: 0.7;
            text-decoration: line-through;
            color: #a0a0a0;
        }

        /* TABELA PRESENÇA */
        .presenca-table {
            width: 100%;
            border-collapse: collapse;
            text-align: center;
        }

        .presenca-table th,
        .presenca-table td {
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 8px;
            cursor: pointer;
        }

        .presenca-table th {
            background-color: #ff8c00;
            color: white;
        }

        .presente {
            background-color: #5cb85c !important;
            color: white;
        }

        /* BOTÕES */
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-primary {
            background-color: #ffc107;
            color: #333;
        }

        .btn-primary:hover {
            background-color: #e0a800;
        }

        .reset-btn {
            margin-top: 15px;
            background-color: #dc3545;
            color: white;
        }

        .reset-btn:hover {
            background-color: #c9302c;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: #0d0d0d;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 2px solid #ff8c00;
        }

        .modal-content img {
            max-width: 100px;
            margin-bottom: 20px;
        }

        #botaoSalvarNome {
            background-color: #ff8c00;
            color: #000;
            margin-top: 10px;
        }

        /* --- CAMPO DE PESQUISA IA --- */
        #ai-search-card {
            order: 3;
            background-color: #1a1a1a;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        #ai-search-card textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: #000000;
            color: #f0f0f0;
            resize: vertical;
            box-sizing: border-box;
        }

        #ai-resposta {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: transparent;
            border-radius: 8px;
            min-height: 50px;
            font-size: 0.9em;
            color: #ccc;
            white-space: pre-wrap;
        }

        #ai-resposta strong {
            color: #ff9933;
        }
        
        /* Status de treino */
        #status-treino {
            margin-top: 15px;
            text-align: center;
            position: relative;
        }
        
        .grafico-treinos-container {
            max-width: 100%;
            margin: 10px auto;
            height: 250px;
            position: relative;
        }
        
        /* Botão discreto de reset */
        .mini-reset-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            padding: 0;
            border-radius: 50%;
            background-color: rgba(220, 53, 69, 0.7);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.3s;
            z-index: 10;
        }
        
        .mini-reset-btn:hover {
            background-color: rgba(220, 53, 69, 1);
            transform: scale(1.1);
        }
        
        .mini-reset-btn i {
            font-style: normal;
        }
        
        /* Legenda melhorada */
        #legenda-cores {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            font-size: 0.8em;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }
        
        .legenda-item {
            display: flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>

<body onload="obterNomeAluno()">

    <nav>
        <a href="professor.html">Acessar a Página do Professor</a>
    </nav>

    <div id="modal-nome" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <img src="logotipo.png" alt="Logo PTF3" onerror="this.style.display='none'">
            <h3>Bem-vindo(a)!</h3>
            <p>Por favor, insira seu nome:</p>
            <input type="text" id="nomeModalInput" placeholder="Ex: Maria da Silva"
                style="
                    width: 100%;
                    padding: 12px;
                    margin-bottom: 12px;
                    background-color: rgba(255,255,255,0.08);
                    color: #f0f0f0;
                    text-align: center;
                    border: 1px solid rgba(255,255,255,0.3);
                    border-radius: 6px;
                    display: block;
                    box-sizing: border-box;
                ">

            <button id="botaoSalvarNome" onclick="salvarNomeModal()">Entrar</button>
        </div>
    </div>

    <div class="header-content">
        <img src="logotipo.png" alt="Logo PTF3" onerror="this.style.display='none'">
        <h1 id="main-title">Seja bem-vindo ao seu Espaço.</h1>
    </div>

    <div class="container">

        <div id="chart-card" class="card">
            <h2> Progressão de Carga</h2>
            <label for="seletorExercicio">Visualizar Exercício:</label>
            <select id="seletorExercicio" onchange="inicializarGrafico()">
                <option value="AgachamentoLivre">Agachamento Livre</option>
                <option value="SupinoReto">Supino Reto</option>
                <option value="PuxadaFrontal">Puxada Frontal</option>
                <option value="RoscaDireta">Rosca Direta</option>
                <option value="TricepsTesta">Tríceps Testa</option>
                <option value="DesenvolvimentoMilitar">Desenvolvimento Militar</option>
                <option value="CadeiraExtensora">Cadeira Extensora</option>
                <option value="ElevacaoPelvica">Elevação Pélvica</option>
            </select>

            <div class="chart-container">
                <canvas id="pesoChart"></canvas>
            </div>

            <div class="input-group">
                <input type="number" id="pesoInput" placeholder="Carga (kg)" step="0.5">
                <button class="btn-primary" onclick="adicionarPeso()">Registrar Carga</button>
            </div>
            <button class="reset-btn" onclick="resetarDados('cargas')">Resetar Histórico</button>
        </div>

        <div id="medidas-card" class="card">
            <h2> Registro de Medidas</h2>
            <p style="margin-bottom: 15px; font-size: 0.9em; color: #ccc; text-align: center;">Acompanhe sua evolução.
            </p>

            <div class="input-container">
                <div class="input-group"><label>Peso (kg)</label><input type="number" id="pesoCorporalInput"
                        placeholder="Ex: 75.5" step="0.1"></div>
                <div class="input-group"><label>Cintura</label><input type="number" id="cinturaInput" placeholder="cm"
                        step="1"></div>
                <div class="input-group"><label>Braço D.</label><input type="number" id="bracoInput" placeholder="cm"
                        step="0.5"></div>
                <div class="input-group"><label>Tórax</label><input type="number" id="toraxInput" placeholder="cm"
                        step="1">
                </div>
                <div class="input-group"><label>Abdômen</label><input type="number" id="abdomenInput" placeholder="cm"
                        step="1"></div>
                <div class="input-group"><label>Coxa D.</label><input type="number" id="coxaInput" placeholder="cm"
                        step="0.5"></div>
                <div class="input-group"><label>Panturrilha</label><input type="number" id="panturrilhaInput"
                        placeholder="cm" step="0.5"></div>
                <div class="input-group"><label>Antebraço</label><input type="number" id="antebracoInput"
                        placeholder="cm" step="0.5"></div>
            </div>

            <button class="btn-primary" onclick="registrarMedidas()">Registrar Medidas</button>

            <h3 style="margin-top: 15px; color: #ff9933; text-align: center;">Últimos Registros</h3>
            <div id="ultimasMedidas" style="font-size: 0.9em; color: #ccc; text-align: center;">Nenhum registro
                encontrado.</div>
            <button class="reset-btn" onclick="resetarDados('medidas')">Resetar Medidas</button>
        </div>

        <div id="treino-card" class="card">
            <h2> Treino de Força</h2>

            <label for="seletorTreino">Selecionar Dia:</label>
            <select id="seletorTreino" onchange="carregarTreinoDoProfessor(this.value)">
                <option value="">Carregando dias de treino...</option>
            </select>
            <hr style="border-color: rgba(255, 255, 255, 0.2);">

            <p style="text-align: center;">
                <strong>Aluno:</strong> <span id="nome-aluno" style="color:#ff9933">...</span> | 
                <strong>Data:</strong> <span id="data-atual"></span>
            </p>

            <!-- Container dinâmico para o treino -->
            <div id="treino-dinamico-container">
                <p style="text-align: center; color: #ccc;">
                    Selecione um dia de treino para visualizar os exercícios.
                </p>
            </div>
        </div>

        <div id="ai-search-card" class="card">
            <h2> IA PTF3</h2>

            <label for="exercicioPergunta">O que você gostaria de saber sobre o exercício?</label>
            <textarea id="exercicioPergunta" placeholder="Ex:'Qual a forma correta de fazer agachamento livre?' Ou 'Quais os músculos ativados no supino?'"></textarea>

            <button class="btn-primary" onclick="simularPesquisaIA()">Perguntar à IA</button>

            <h3 style="margin-top: 15px; color: #ff9933; text-align: center;">Resposta da IA</h3>
            <div id="ai-resposta">
                
            </div>
        </div>
        
        <div id="presenca-card" class="card">
            <h2> Presença Mensal</h2>
            <p style="text-align: center;">Clique nas datas para marcar.</p>
            <table class="presenca-table">
                <thead>
                    <tr>
                        <th>Dom</th>
                        <th>Seg</th>
                        <th>Ter</th>
                        <th>Qua</th>
                        <th>Qui</th>
                        <th>Sex</th>
                        <th>Sáb</th>
                    </tr>
                </thead>
                <tbody id="calendario-body"></tbody>
            </table>
            
            <!-- STATUS DE TREINO E GRÁFICO COM CORES DINÂMICAS -->
            <div id="status-treino" class="card" style="margin-top:15px; text-align:center; border: 1px solid rgba(255,255,255,0.1); padding: 15px;">
                <h3 style="color:#ff9933; margin-top: 0;">Histórico de Treinos</h3>
                
                <!-- Botão discreto de reset -->
                <button class="mini-reset-btn" onclick="resetarDados('treinos')" title="Resetar Histórico de Treinos">
                    <i>↺</i>
                </button>
                
                <p id="ultimo-treino" style="color:#ccc; font-size: 0.9em;">Carregando último treino...</p>
                <p id="contador-treinos" style="color:#ffd700; font-weight:bold; font-size: 1.1em;">Treinos no mês: 0</p>

                <div class="grafico-treinos-container">
                    <canvas id="graficoTreinos" height="250"></canvas>
                </div>
                
                <!-- LEGENDA DAS CORES (será atualizada dinamicamente) -->
                <div id="legenda-cores">
                    <div class="legenda-item">
                        <div style="width: 12px; height: 12px; background-color: #ff6b6b; margin-right: 5px; border-radius: 2px;"></div>
                        <span style="color: #ccc;">Treino A</span>
                    </div>
                    <div class="legenda-item">
                        <div style="width: 12px; height: 12px; background-color: #4ecdc4; margin-right: 5px; border-radius: 2px;"></div>
                        <span style="color: #ccc;">Treino B</span>
                    </div>
                    <div class="legenda-item">
                        <div style="width: 12px; height: 12px; background-color: #ffd166; margin-right: 5px; border-radius: 2px;"></div>
                        <span style="color: #ccc;">Treino C</span>
                    </div>
                    <div class="legenda-item">
                        <div style="width: 12px; height: 12px; background-color: #06d6a0; margin-right: 5px; border-radius: 2px;"></div>
                        <span style="color: #ccc;">Treino D</span>
                    </div>
                    <div class="legenda-item">
                        <div style="width: 12px; height: 12px; background-color: #118ab2; margin-right: 5px; border-radius: 2px;"></div>
                        <span style="color: #ccc;">Outros</span>
                    </div>
                </div>
            </div>
    
            <button class="reset-btn" onclick="resetarDados('presenca')">Resetar Presenças</button>
        </div>

    </div>

    <script>
        // Service worker PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registrado com sucesso:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Falha ao registrar Service Worker:', error);
                    });
            });
        }

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDlKdyL4QgpEj1YqBr2xCs0F3aM1o82ef0",
            authDomain: "ptf03-26fdb.firebaseapp.com",
            databaseURL: "https://ptf03-26fdb-default-rtdb.firebaseio.com",
            projectId: "ptf03-26fdb",
            storageBucket: "ptf03-26fdb.firebasestorage.app",
            messagingSenderId: "1020981883676",
            appId: "1:1020981883676:web:7b26aca25ddb1dc02100d9"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let alunoNome = '';
        let pesoChart;
        let chartTreinos = null;
        let coresPorTreino = {
            'A': '#ff6b6b',
            'B': '#4ecdc4',
            'C': '#ffd166',
            'D': '#06d6a0',
            'E': '#118ab2',
            'F': '#ef476f',
            'G': '#073b4c',
            'default': '#6c757d'
        };

        function getPath(sub) {
            return `alunos/${alunoNome.replace(/\s/g, '_')}/${sub}`;
        }

        /* -------- BANCO DE DADOS DA IA (AMPLIADO) -------- */
        const rawData = [
            // --- MUSCULAÇÃO PEITO ---
            "Supino Reto | Musculação | Peito | Peitoral Maior, Deltóide Anterior, Tríceps | Deite no banco com os pés firmes no chão. Segure a barra um pouco mais aberto que a largura dos ombros. Desça a barra de forma controlada até a linha do peito, mantendo os cotovelos levemente abaixo da linha dos ombros. Empurre a barra para cima estendendo os braços sem travar totalmente os cotovelos. | Mantenha as escápulas retraídas (ombros para trás e para baixo) e o peito aberto. Evite bater a barra no peito ou estender demais os cotovelos para não sobrecarregar as articulações.",
            "Supino Inclinado com Barra | Musculação | Peito | Peitoral Superior, Deltóide Anterior, Tríceps | Ajuste o banco em cerca de 30–45°. Deite-se, posicione as mãos um pouco mais abertas que os ombros e retire a barra do suporte. Desça-a em direção à parte alta do peito, controlando o movimento, e empurre a barra para cima até quase estender os cotovelos. | Não exagere na inclinação do banco para não transferir demais a carga para os ombros. Mantenha os pés firmes no chão e o glúteo encostado no banco durante todo o movimento.",
            "Supino Declinado | Musculação | Peito | Peitoral Inferior, Tríceps, Deltóide Anterior | Deite no banco declinado com o corpo bem preso. Segure a barra em pegada um pouco maior que a largura dos ombros. Desça a barra em direção à parte baixa do peito/esterno e empurre para cima estendendo os braços. | Use um parceiro ou segurança ao manusear cargas mais altas. Mantenha o controle da barra em todo o trajeto, evitando que desça muito rápido.",
            "Supino com Halteres | Musculação | Peito | Peitoral Maior, Deltóide Anterior, Tríceps | Deite no banco com um halter em cada mão na linha do peito, cotovelos levemente para fora. Empurre os halteres para cima até quase estender os cotovelos, aproximando levemente os halteres no topo, e desça de forma controlada. | Não junte demais os halteres no topo para não perder a estabilidade. Mantenha o punho neutro, alinhado com o antebraço, sem deixá-lo dobrar para trás.",
            "Crucifixo com Halteres | Musculação | Peito | Peitoral Maior, Peitoral Menor | Deite no banco com um halter em cada mão, braços semi-estendidos acima do peito. Abra os braços em arco lateral até sentir alongamento no peitoral, mantendo uma leve flexão nos cotovelos, e retorne ao topo aproximando as mãos. | Não desça além da sua mobilidade para evitar estresse no ombro. Pense em abraçar um barril, não em esticar o braço totalmente reto.",

            // --- MUSCULAÇÃO COSTAS ---
            "Puxada Frontal na Barra | Musculação | Costas | Latíssimo do Dorso, Trapézio, Bíceps | Sentado na máquina, segure a barra com pegada aberta, palma para frente. Puxe a barra em direção à parte superior do peito, trazendo o peito levemente para frente, e retorne os braços à posição inicial de forma controlada. | Evite puxar a barra atrás da cabeça para proteger a cervical e os ombros. Concentre-se em aproximar as escápulas em vez de só dobrar os cotovelos.",
            "Remada Curvada com Barra | Musculação | Costas | Latíssimo do Dorso, Trapézio, Eretor da Coluna, Bíceps | Em pé, flexione ligeiramente os joelhos e incline o tronco à frente mantendo a coluna neutra. Segure a barra em pronação e puxe-a em direção ao abdômen, aproximando as escápulas. Desça a barra de forma controlada. | Não arredonde a lombar. Mantenha o abdômen contraído e escolha uma carga que permita manter a postura o tempo todo.",
            "Remada Baixa na Polia | Musculação | Costas | Latíssimo do Dorso, Trapézio, Romboides, Bíceps | Sentado, com os pés apoiados, segure a barra ou triangulo e puxe em direção ao abdômen, mantendo o tronco relativamente estável. Contraia bem as costas e retorne de forma controlada. | Evite balançar o tronco para usar impulso. Foque em puxar com as costas, não apenas com os braços.",
            "Levantamento Terra | Musculação | Corpo Inteiro | Isquiotibiais, Glúteos, Eretor da Coluna, Trapézio, Antebraços | Em pé, com os pés na largura dos ombros, segure a barra próxima às pernas. Flexione quadril e joelhos mantendo a coluna neutra, pegue a barra e estenda quadris e joelhos levantando o peso até ficar em pé. Retorne abaixando a barra próxima ao corpo. | Mantenha a barra sempre próxima às pernas, peito aberto e lombar neutra. Comece com cargas leves até dominar a técnica.",

            // --- MUSCULAÇÃO PERNAS / GLÚTEOS ---
            "Agachamento Livre | Musculação | Pernas/Glúteos | Quadríceps, Glúteo Máximo, Isquiotibiais | Com a barra apoiada nas costas (trapézio), posicione os pés na largura dos ombros. Flexione quadris e joelhos como se fosse sentar, mantendo o peito alto e joelhos alinhados com os pés. Desça até a profundidade segura e suba estendendo quadris e joelhos. | Distribua o peso entre meio do pé e calcanhar. Evite que os joelhos colapsem para dentro e não arredonde a lombar no fundo do movimento.",
            "Leg Press 45° | Musculação | Pernas/Glúteos | Quadríceps, Glúteo Máximo, Isquiotibiais | Sentado na máquina, posicione os pés na plataforma na largura dos ombros. Destrave o aparelho, flexione os joelhos controlando a descida e empurre a plataforma até quase estender as pernas, sem travar completamente. | Não desça além da sua mobilidade, evitando que a lombar arredonde. Mantenha sempre a lombar em contato com o encosto.",
            "Cadeira Extensora | Musculação | Quadríceps | Quadríceps | Sente-se na máquina com o joelho alinhado ao eixo do equipamento. Comece com os joelhos flexionados a cerca de 90°. Estenda as pernas contra a resistência e retorne de forma controlada. | Ajuste o encosto para que as costas fiquem apoiadas. Evite chutar o peso de forma explosiva; use movimento controlado.",
            "Mesa Flexora | Musculação | Posterior de Coxa | Isquiotibiais | Deitado de barriga para baixo na máquina, encaixe os calcanhares no rolo. Flexione os joelhos trazendo o rolo em direção aos glúteos e retorne lento à posição inicial. | Mantenha o quadril apoiado no banco, evitando erguer o quadril para roubar carga.",
            "Elevação Pélvica com Barra | Musculação | Glúteos | Glúteo Máximo, Isquiotibiais | Sente-se no chão apoiando as costas em um banco. Posicione a barra sobre o quadril com acolchoamento. Flexione os joelhos, pés apoiados no chão. Eleve o quadril até formar uma linha ombro–quadril–joelho e desça de forma controlada. | Mantenha o queixo levemente recolhido e a costela fechada para não hiperextender a lombar. Foque em contrair o glúteo no topo.",

            // --- MUSCULAÇÃO OMBROS / BRAÇOS ---
            "Desenvolvimento Militar com Barra | Musculação | Ombros | Deltóide Anterior, Deltóide Médio, Tríceps | Em pé, segure a barra na altura do queixo, mãos um pouco mais abertas que os ombros. Empurre a barra acima da cabeça estendendo os cotovelos e retorne até próximo ao queixo. | Não incline muito a lombar para trás. Aperte o abdômen e glúteos para estabilizar a coluna.",
            "Elevação Lateral com Halteres | Musculação | Ombros | Deltóide Médio, Trapézio Superior | Em pé, segure um halter em cada mão ao lado do corpo. Com leve flexão nos cotovelos, eleve os braços lateralmente até a altura dos ombros e retorne devagar. | Não use impulso excessivo com o tronco. Mantenha os ombros longe das orelhas e controle a descida.",
            "Rosca Direta com Barra | Musculação | Bíceps | Bíceps Braquial, Braquial, Braquiorradial | Em pé, segure a barra com pegada supinada na largura dos ombros. Flexione os cotovelos trazendo a barra em direção ao peito, mantendo os braços próximos ao tronco, e desça de forma controlada. | Evite balançar o tronco ou usar impulso do quadril. Concentre-se em manter os cotovelos fixos.",
            "Rosca Alternada com Halteres | Musculação | Bíceps | Bíceps Braquial, Braquiorradial | Em pé, um halter em cada mão. Gire a palma da mão para frente e flexione o cotovelo de um lado por vez, levando o halter em direção ao ombro. Desça controlando o movimento. | Não gire excessivamente o tronco. Mantenha o abdômen firme e execute o movimento de forma fluida.",
            "Tríceps Testa com Barra | Musculação | Tríceps | Tríceps Braquial | Deitado no banco, segure a barra com pegada fechada, braços estendidos acima do peito. Flexione os cotovelos trazendo a barra em direção à testa (ou um pouco acima dela) e estenda novamente. | Mantenha os cotovelos apontando para cima, sem abrir demais para os lados. Use carga que permita controle total do movimento.",
            "Tríceps Pulley (Corda ou Barra) | Musculação | Tríceps | Tríceps Braquial | Em pé, de frente para a polia alta, segure a barra ou corda. Com os cotovelos junto ao tronco, estenda os cotovelos empurrando a alça para baixo até alongar completamente o tríceps. Retorne devagar. | Evite balançar o tronco. Mantenha o ombro estável e foque na extensão completa do cotovelo.",

            // --- MUSCULAÇÃO CORE / ABDÔMEN ---
            "Prancha Ventral | Musculação | Core | Reto Abdominal, Oblíquos, Transverso do Abdome, Estabilizadores da Coluna | Apoie os antebraços e a ponta dos pés no chão, alinhando ombros, quadris e tornozelos. Mantenha o corpo em linha reta, contraindo abdômen e glúteos, respirando normalmente. | Não deixe o quadril subir demais nem despencar. Pense em empurrar o chão com os cotovelos e manter o pescoço neutro.",
            "Abdominal Crunch | Musculação | Abdômen | Reto Abdominal | Deitado de costas, joelhos flexionados, pés apoiados. Mãos atrás da cabeça ou cruzadas no peito. Eleve a parte superior do tronco em direção aos joelhos, focando em aproximar costelas do quadril, e retorne devagar. | Não puxe o pescoço com as mãos. O movimento é curto e controlado, sem “sentar” completamente.",

            // --- ALONGAMENTOS ---
            "Alongamento de Isquiotibiais em Pé | Alongamento | Pernas | Isquiotibiais, Panturrilhas | Em pé, apoie o calcanhar de uma perna em um banco baixo. Mantenha o joelho levemente flexionado e incline o tronco à frente em direção ao pé, mantendo a coluna neutra, até sentir alongamento atrás da coxa. | Não force além do desconforto leve. Mantenha a respiração calma e sustente o alongamento por 20–30 segundos.",
            "Alongamento de Peitoral na Parede | Alongamento | Peito/Ombros | Peitoral Maior, Peitoral Menor, Deltóide Anterior | De pé, coloque a palma da mão e o antebraço na parede, com o cotovelo na altura do ombro. Gire suavemente o tronco para o lado oposto até sentir alongar o peito. | Evite girar excessivamente a lombar. Foque na sensação de abertura no peito e ombro, sem dor aguda.",
            "Alongamento de Quadríceps em Pé | Alongamento | Pernas | Quadríceps | Em pé, segure o tornozelo de uma perna atrás do corpo, aproximando o calcanhar do glúteo. Mantenha os joelhos alinhados e o tronco ereto. | Não deixe o joelho abrir para o lado. Contraia levemente o glúteo da perna alongada para aumentar a eficiência do alongamento.",

            // --- CROSSFIT / FUNCIONAL ---
            "Burpee | CrossFit | Corpo Inteiro | Peito, Ombros, Tríceps, Quadríceps, Glúteos, Core | Em pé, agache e apoie as mãos no chão. Jogue os pés para trás caindo em posição de prancha, faça uma flexão (opcional), retorne os pés próximo às mãos e salte estendendo braços acima da cabeça. | Comece devagar para aprender a coordenação. Se necessário, retire a flexão ou o salto até ganhar condicionamento.",
            "Kettlebell Swing | CrossFit | Pernas/Glúteos/Core | Glúteos, Isquiotibiais, Lombar, Ombros | Com os pés na largura dos ombros, segure o kettlebell com as duas mãos. Flexione levemente os joelhos e projete o quadril para trás, balançando o kettlebell entre as pernas. Estenda o quadril com força para projetar o kettlebell até a altura do peito. | O movimento é de quadril, não de braço. Mantenha a coluna neutra e o peso próximo ao corpo.",
            "Box Jump | CrossFit | Pernas | Quadríceps, Glúteos, Panturrilhas | Em frente ao box/caixa, agache levemente e salte para cima, pousando com os dois pés sobre o box, joelhos flexionados para amortecer. Desça com cuidado, step-by-step se necessário. | Use altura de box adequada à sua capacidade. Foque em pousar silenciosamente, com controle.",
            "Wall Ball | CrossFit | Corpo Inteiro | Quadríceps, Glúteos, Ombros, Tríceps, Core | Segure a bola medicinal na frente do peito, agache até a coxa ficar paralela ao chão e, subindo, arremesse a bola em direção ao alvo na parede. Receba a bola flexionando novamente o quadril e joelhos. | Não deixe a lombar arredondar no agachamento. Sincronize agachar e arremessar, usando potência de pernas + braços.",

            // --- GINÁSTICA / CALISTENIA ---
            "Barra Fixa Pegada Pronada | Ginástica | Costas/Braços | Latíssimo do Dorso, Bíceps, Trapézio | Segure a barra com as palmas voltadas para frente, mãos um pouco mais abertas que os ombros. Inicie pendurado e puxe o corpo até o queixo ultrapassar a barra, depois desça de forma controlada. | Evite balançar em excesso. Comece com variações assistidas (elástico, máquina) se ainda não consegue executar completo.",
            "Flexão de Braços no Solo | Ginástica | Peito/Braços | Peitoral Maior, Deltóide Anterior, Tríceps, Core | Em posição de prancha alta, mãos na largura dos ombros. Flexione os cotovelos levando o peito em direção ao chão e estenda de volta, mantendo o corpo alinhado. | Se necessário, apoie os joelhos para reduzir a carga. Não deixe o quadril descer ou subir demais.",
            "Parada de Mãos na Parede (Handstand) | Ginástica | Ombros/Core | Deltóides, Trapézio, Core | De costas para a parede, coloque as mãos no chão à frente e chute as pernas até apoiar os pés na parede. Mantenha braços estendidos e corpo alinhado. | Comece com supervisão e local seguro. Não force a cervical; a maior parte do peso deve ser suportada pelos ombros e mãos.",

            // --- PILATES / ESTABILIZAÇÃO ---
            "Hundred Pilates | Pilates | Core | Reto Abdominal, Oblíquos, Flexores de Quadril | Deitado de costas, eleve as pernas em ângulo de 90° (ou estendidas a 45°) e a cabeça e ombros do chão. Estenda os braços ao lado do corpo e pulse para cima e para baixo enquanto inspira por 5 tempos e expira por 5 tempos, até contar 100 pulsos. | Se for iniciante, mantenha os pés apoiados no chão ou pernas mais altas. Não force o pescoço; pense em alongar a nuca.",
            "Ponte de Ombros (Shoulder Bridge) | Pilates | Glúteos/Core | Glúteo Máximo, Isquiotibiais, Paravertebrais | Deitado de costas, joelhos flexionados, pés apoiados. Eleve a pelve enrolando a coluna vértebra por vértebra até formar uma linha ombro–quadril–joelho, depois desenrole voltando ao solo. | Mantenha o peso distribuído entre ombros e pés, evitando pressionar o pescoço. Controle a subida e descida sem “quebras” bruscas.",
            "Swimming Pilates | Pilates | Coluna/Costas | Paravertebrais, Glúteos, Ombros | Deitado de barriga para baixo, braços estendidos à frente. Eleve braço direito e perna esquerda e depois alterne com braço esquerdo e perna direita em movimento rápido e controlado, como se estivesse nadando. | Mantenha o abdômen levemente contraído para proteger a lombar. O movimento é pequeno; não exagere na amplitude."
        ];

        const bancoDeExercicios = {};

        rawData.forEach(item => {
            const parts = item.split(' | ');
            if (parts.length === 6) {
                const [nome, modalidade, categoria, musculos, execucao, dica] = parts;
                const key = normalize(nome).replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
                const searchTerms = [
                    ...nome.split(/\s+/).map(normalize),
                    ...musculos.split(/,\s*/).map(normalize).filter(t => t.length > 2),
                    normalize(categoria),
                    normalize(modalidade)
                ];

                bancoDeExercicios[key] = {
                    nome: nome,
                    modalidade: modalidade,
                    categoria: categoria,
                    musculos: musculos,
                    execucao: execucao,
                    dica: dica,
                    termos: [...new Set(searchTerms.filter(t => t))]
                };
            }
        });

        function normalize(str) {
            return str.toLowerCase().replace(/[^a-z0-9\s]/g, '');
        }

        function obterNomeAluno() {
            const nomeLocal = localStorage.getItem('nomeAluno');
            if (!nomeLocal) {
                document.getElementById('modal-nome').style.display = 'flex';
            } else {
                alunoNome = nomeLocal;
                start();
            }
        }

        function salvarNomeModal() {
            const n = document.getElementById('nomeModalInput').value.trim();
            if (n.length < 2) return alert('Por favor, insira um nome válido!');
            alunoNome = n;
            localStorage.setItem('nomeAluno', n);
            document.getElementById('modal-nome').style.display = 'none';
            start();
        }

        // Carrega dias de treino do aluno
        function carregarDiasTreino() {
            const select = document.getElementById('seletorTreino');
            select.innerHTML = '<option value="">Carregando...</option>';
            
            database.ref(getPath('treinoModel')).once('value', snapshot => {
                if (!snapshot.exists()) {
                    select.innerHTML = '<option value="">Nenhum treino disponível</option>';
                    return;
                }
                
                select.innerHTML = '';
                
                snapshot.forEach(childSnapshot => {
                    const dia = childSnapshot.key;
                    const option = document.createElement('option');
                    option.value = dia;
                    option.textContent = dia;
                    select.appendChild(option);
                });
                
                if (select.options.length > 0) {
                    select.value = select.options[0].value;
                    carregarTreinoDoProfessor(select.value);
                }
            });
        }

        // Finalizar treino (registra em treinosFinalizados)
        function finalizarTreino() {
            try {
                const select = document.getElementById('seletorTreino');
                const dia = select ? select.value : null;
                
                if (!dia) {
                    alert('Selecione um treino primeiro!');
                    return;
                }
                
                const tipoTreino = extrairTipoTreino(dia);
                const treinoComTipo = tipoTreino ? `${dia} (Treino ${tipoTreino})` : dia;
                
                const agora = new Date();
                const dataLegivel = agora.toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit', year:'numeric'});
                const horaLegivel = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                
                const listaEl = document.getElementById('lista-treino-dinamico');
                const concluidos = [];
                
                if (listaEl) {
                    listaEl.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        if (cb.checked) {
                            const li = cb.closest('li');
                            const nome = li.querySelector('.exercicio-info strong')?.textContent.trim() || 'Exercício';
                            concluidos.push(nome);
                        }
                    });
                }
                
                const payload = {
                    dia: treinoComTipo,
                    tipo: tipoTreino || extrairTipoTreinoManual(),
                    data: dataLegivel,
                    hora: horaLegivel,
                    timestamp: Date.now(),
                    concluido: true,
                    concluidoCount: concluidos.length,
                    exerciciosConcluidos: concluidos
                };
                
                console.log('Salvando treino:', payload);
                
                const ref = database.ref(getPath('treinosFinalizados')).push();
                ref.set(payload)
                    .then(() => {
                        alert(`Treino ${treinoComTipo} registrado com sucesso!`);
                        carregarUltimoTreino();
                        contarTreinosDoMes();
                        marcarTreinoNoCalendario(new Date());
                        carregarTreinosFinalizados();
                    })
                    .catch(err => {
                        console.error('Erro ao salvar treino finalizado:', err);
                        alert('Erro ao registrar treino. Tente novamente.');
                    });
            } catch(err) {
                console.error('Erro em finalizarTreino():', err);
                alert('Erro ao registrar treino. Tente novamente.');
            }
        }

        // Extrai tipo de treino (A, B, C...)
        function extrairTipoTreino(diaString) {
            if (!diaString) return null;
            const str = diaString.toString();
            const patterns = [
                /(?:Treino|Dia|Workout)[\s:]*([ABCDEFG])/i,
                /\(([ABCDEFG])\)/i,
                /[:\-]\s*([ABCDEFG])/i,
                /\b([ABCDEFG])\b(?!\w)/i
            ];
            
            for (const pattern of patterns) {
                const match = str.match(pattern);
                if (match && match[1]) {
                    const tipo = match[1].toUpperCase();
                    console.log(`Extraído de "${diaString}": ${tipo} (padrão: ${pattern})`);
                    return tipo;
                }
            }
            
            const ultimoChar = str.trim().slice(-1);
            if (ultimoChar.match(/[ABCDEFG]/i)) {
                console.log(`Extraído (último char) de "${diaString}": ${ultimoChar.toUpperCase()}`);
                return ultimoChar.toUpperCase();
            }
            
            console.log(`Nenhum tipo encontrado em: "${diaString}"`);
            return null;
        }

        function extrairTipoTreinoManual() {
            const ultimoTipo = localStorage.getItem('ultimoTipoTreino') || 'D';
            const tipos = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
            const indexAtual = tipos.indexOf(ultimoTipo);
            const proximoIndex = (indexAtual + 1) % tipos.length;
            const novoTipo = tipos[proximoIndex];
            localStorage.setItem('ultimoTipoTreino', novoTipo);
            return novoTipo;
        }

        function carregarUltimoTreino() {
            try {
                const ref = database.ref(getPath('treinosFinalizados'));
                ref.orderByChild('timestamp').limitToLast(1).on('value', snap => {
                    const p = document.getElementById('ultimo-treino');
                    if (!p) return;
                    if (!snap.exists()) {
                        p.textContent = 'Nenhum treino registrado ainda.';
                        return;
                    }
                    snap.forEach(child => {
                        const t = child.val();
                        p.textContent = `Último treino: ${t.dia} — ${t.data} às ${t.hora}`;
                    });
                });
            } catch (err) { console.warn('carregarUltimoTreino erro', err); }
        }

        function contarTreinosDoMes() {
            try {
                const mesAtual = new Date().getMonth() + 1;
                const anoAtual = new Date().getFullYear();
                let total = 0;
                database.ref(getPath('treinosFinalizados')).once('value').then(snap => {
                    snap.forEach(c => {
                        const t = c.val();
                        if (!t || !t.data) return;
                        const parts = t.data.split('/');
                        if (parts.length >= 2) {
                            const mesT = parseInt(parts[1], 10);
                            const anoT = parseInt(parts[2] || anoAtual, 10);
                            if (mesT === mesAtual && anoT === anoAtual) total++;
                        }
                    });
                    const el = document.getElementById('contador-treinos');
                    if (el) el.textContent = `Treinos no mês: ${total}`;
                }).catch(err => console.warn('contarTreinosDoMes erro', err));
            } catch (err) { console.warn('contarTreinosDoMes erro', err); }
        }

        function carregarTreinosFinalizados() {
            try {
                const ref = database.ref(getPath('treinosFinalizados'));
                ref.orderByChild('timestamp').once('value').then(snap => {
                    const lista = [];
                    snap.forEach(c => {
                        const treino = c.val();
                        treino.id = c.key;
                        lista.push(treino);
                    });
                    
                    console.log('Treinos carregados:', lista.length);
                    renderTreinosBarChart(lista);
                }).catch(err => console.warn('carregarTreinosFinalizados erro', err));
            } catch (err) { console.warn('carregarTreinosFinalizados erro', err); }
        }

        // Gráfico de barras de treinos
        function renderTreinosBarChart(treinosLista) {
            try {
                const canvas = document.getElementById('graficoTreinos');
                if (!canvas) return;
                
                if (!treinosLista || treinosLista.length === 0) {
                    if (chartTreinos) chartTreinos.destroy();
                    chartTreinos = null;
                    canvas.style.display = 'none';
                    atualizarLegendaCores([], coresPorTreino);
                    return;
                }
                
                canvas.style.display = 'block';
                
                const treinosOrdenados = treinosLista.slice().sort((a, b) => {
                    return (a.timestamp || 0) - (b.timestamp || 0);
                });

                console.log('Treinos ordenados para gráfico:', treinosOrdenados);

                const labels = treinosOrdenados.map((t, index) => `${index + 1}`);
                const dados = treinosOrdenados.map(t => t.concluidoCount || 1);
                
                const cores = treinosOrdenados.map(t => {
                    const tipo = t.tipo || extrairTipoTreino(t.dia);
                    console.log(`Treino: "${t.dia}" -> Tipo: ${tipo} -> Cor: ${coresPorTreino[tipo] || coresPorTreino.default}`);
                    if (tipo && coresPorTreino[tipo]) {
                        return coresPorTreino[tipo];
                    }
                    return coresPorTreino.default;
                });

                atualizarLegendaCores(treinosOrdenados, coresPorTreino);

                if (typeof Chart === 'undefined') { 
                    console.warn('Chart.js não carregado, tentando novamente...');
                    setTimeout(() => renderTreinosBarChart(treinosLista), 1000);
                    return;
                }

                const ctx = canvas.getContext('2d');
                if (chartTreinos) chartTreinos.destroy();

                chartTreinos = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Exercícios Concluídos',
                            data: dados,
                            backgroundColor: cores,
                            borderColor: 'rgba(255, 255, 255, 0.3)',
                            borderWidth: 1,
                            borderRadius: 4,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { 
                                display: true,
                                ticks: { 
                                    color: '#f0f0f0',
                                    font: { size: 11 },
                                    maxRotation: 0,
                                    minRotation: 0
                                },
                                grid: { 
                                    display: false
                                }
                            },
                            y: { 
                                beginAtZero: true, 
                                ticks: { 
                                    color: '#f0f0f0',
                                    stepSize: 1,
                                    precision: 0
                                },
                                grid: { color: 'rgba(255,255,255,0.1)' },
                                title: {
                                    display: false
                                }
                            }
                        },
                        plugins: {
                            legend: { 
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const treino = treinosOrdenados[context[0].dataIndex];
                                        const tipo = treino.tipo || extrairTipoTreino(treino.dia);
                                        const tipoStr = tipo ? ` (Treino ${tipo})` : '';
                                        return `Treino ${context[0].label}: ${treino.dia || 'Treino'}${tipoStr}`;
                                    },
                                    label: function(context) {
                                        const treino = treinosOrdenados[context.dataIndex];
                                        let label = `Exercícios concluídos: ${context.raw}`;
                                        if (treino.data) label += ` | Data: ${treino.data}`;
                                        if (treino.hora) label += ` ${treino.hora}`;
                                        return label;
                                    },
                                    afterLabel: function(context) {
                                        const treino = treinosOrdenados[context.dataIndex];
                                        if (treino.exerciciosConcluidos && treino.exerciciosConcluidos.length > 0) {
                                            return `Exercícios: ${treino.exerciciosConcluidos.slice(0, 3).join(', ')}${treino.exerciciosConcluidos.length > 3 ? '...' : ''}`;
                                        }
                                        return '';
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ff9933',
                                bodyColor: '#f0f0f0',
                                borderColor: '#ff8c00',
                                borderWidth: 1
                            }
                        }
                    }
                });
            } catch(err) { 
                console.warn('renderTreinosBarChart erro:', err);
                setTimeout(() => {
                    if (treinosLista) renderTreinosBarChart(treinosLista);
                }, 2000);
            }
        }
        
        function atualizarLegendaCores(treinosOrdenados, coresPorTreino) {
            const tiposPresentes = new Set();
            treinosOrdenados.forEach(t => {
                const tipo = t.tipo || extrairTipoTreino(t.dia);
                if (tipo) {
                    tiposPresentes.add(tipo.toUpperCase());
                }
            });
            
            const temOutros = treinosOrdenados.some(t => !(t.tipo || extrairTipoTreino(t.dia)));
            const todosTipos = ['A', 'B', 'C', 'D', 'E', 'F', 'G'];
            const tiposFiltrados = todosTipos.filter(t => tiposPresentes.has(t));
            
            const legendaContainer = document.getElementById('legenda-cores');
            if (legendaContainer) {
                let html = '';
                
                tiposFiltrados.forEach(tipo => {
                    if (coresPorTreino[tipo]) {
                        html += `
                            <div class="legenda-item">
                                <div style="width: 12px; height: 12px; background-color: ${coresPorTreino[tipo]}; margin-right: 5px; border-radius: 2px;"></div>
                                <span style="color: #ccc;">Treino ${tipo}</span>
                            </div>
                        `;
                    }
                });
                
                if (temOutros) {
                    html += `
                        <div class="legenda-item">
                            <div style="width: 12px; height: 12px; background-color: ${coresPorTreino.default}; margin-right: 5px; border-radius: 2px;"></div>
                            <span style="color: #ccc;">Outros</span>
                        </div>
                    `;
                }
                
                if (tiposFiltrados.length === 0 && !temOutros) {
                    html = '<div style="color: #ccc; font-size: 0.8em;">Nenhum treino registrado</div>';
                }
                
                legendaContainer.innerHTML = html;
            }
        }

        function marcarTreinoNoCalendario(dataObj) {
            try {
                const dia = String(dataObj.getDate()).padStart(2,'0');
                const mes = String(dataObj.getMonth()+1).padStart(2,'0');
                const ano = dataObj.getFullYear();
                const chave = `${dia}-${mes}-${ano}`;
                database.ref(getPath(`calendario/${chave}`)).set({ treinou: true, timestamp: Date.now() }).catch(e=>console.warn('marcarTreinoNoCalendario erro', e));
            } catch(e){ console.warn('marcarTreinoNoCalendario erro', e); }
        }

        // Escolhe automaticamente exercício com mais de 2 pontos
        function escolherExercicioInicial() {
            return new Promise((resolve) => {
                const MIN_PONTOS = 3;
                
                database.ref(getPath('cargas')).once('value')
                    .then((snap) => {
                        if (!snap.exists()) {
                            return resolve(null);
                        }

                        let melhorExercicio = null;

                        snap.forEach((child) => {
                            const nomeExercicio = child.key;
                            const qtdRegistros = child.numChildren();

                            if (!melhorExercicio && qtdRegistros >= MIN_PONTOS) {
                                melhorExercicio = nomeExercicio;
                            }
                        });

                        resolve(melhorExercicio);
                    })
                    .catch((e) => {
                        console.warn('Erro ao buscar cargas para exercício inicial:', e);
                        resolve(null);
                    });
            });
        }

        async function start() {
            document.getElementById('main-title').textContent = `Olá, ${alunoNome}!`;
            document.getElementById('nome-aluno').textContent = alunoNome;
            document.getElementById('data-atual').textContent = new Date().toLocaleDateString('pt-BR');

            const exercicioInicial = await escolherExercicioInicial();

            if (exercicioInicial) {
                const seletor = document.getElementById('seletorExercicio');
                if (seletor) {
                    seletor.value = exercicioInicial;
                }
            }

            inicializarGrafico();
            carregarUltimasMedidas();
            gerarCalendario();
            carregarDiasTreino();
            carregarUltimoTreino();
            contarTreinosDoMes();
            
            if (typeof Chart !== 'undefined') {
                carregarTreinosFinalizados();
            } else {
                setTimeout(() => {
                    carregarTreinosFinalizados();
                }, 1000);
            }
        }

        function inicializarGrafico() {
            const ex = document.getElementById('seletorExercicio').value;
            database.ref(getPath(`cargas/${ex}`)).on('value', snap => {
                const datas = [];
                const pesos = [];
                snap.forEach(c => {
                    const v = c.val();
                    datas.push(v.data);
                    pesos.push(v.peso);
                });

                const ctx = document.getElementById('pesoChart').getContext('2d');
                if (pesoChart) pesoChart.destroy();
                pesoChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: datas,
                        datasets: [{
                            label: `Carga (kg)`,
                            data: pesos,
                            borderColor: '#ff8c00',
                            backgroundColor: 'rgba(255,140,0,0.2)',
                            tension: 0.2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#333' },
                                ticks: { color: '#f0f0f0' }
                            },
                            x: {
                                grid: { color: '#333' },
                                ticks: { color: '#f0f0f0' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#f0f0f0' } }
                        }
                    }
                });
            });
        }

        function adicionarPeso() {
            const p = document.getElementById('pesoInput').value;
            if (!p || isNaN(parseFloat(p)) || parseFloat(p) <= 0) {
                alert('Por favor, insira uma carga válida e positiva.');
                return;
            }
            const ex = document.getElementById('seletorExercicio').value;
            const agora = new Date();
            const dataLegivel = agora.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) +
                ' ' + agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            database.ref(getPath(`cargas/${ex}`)).push({
                data: dataLegivel,
                peso: parseFloat(p),
                timestamp: Date.now()
            }).then(() => {
                document.getElementById('pesoInput').value = '';
            }).catch(error => {
                console.error("Erro ao adicionar peso:", error);
                alert("Erro ao registrar carga.");
            });
        }

        function registrarMedidas() {
            const peso = document.getElementById('pesoCorporalInput').value;
            if (!peso) return alert('O peso é obrigatório!');

            const m = {
                data: new Date().toLocaleDateString('pt-BR'),
                timestamp: Date.now(),
                peso: peso,
                cintura: document.getElementById('cinturaInput').value,
                braco: document.getElementById('bracoInput').value,
                torax: document.getElementById('toraxInput').value,
                abdomen: document.getElementById('abdomenInput').value,
                coxa: document.getElementById('coxaInput').value,
                panturrilha: document.getElementById('panturrilhaInput').value,
                antebraco: document.getElementById('antebracoInput').value
            };
            database.ref(getPath('medidas')).push(m);
            alert('Medidas Salvas!');
            document.querySelectorAll('#medidas-card input').forEach(i => i.value = '');
            carregarUltimasMedidas();
        }

        function carregarUltimasMedidas() {
            database.ref(getPath('medidas')).limitToLast(1).once('value', snap => {
                const div = document.getElementById('ultimasMedidas');
                div.innerHTML = 'Nenhum registro encontrado.';
                snap.forEach(c => {
                    const d = c.val();
                    div.innerHTML =
                        `<strong>${d.data}</strong>: ${d.peso}kg | Cintura: ${d.cintura||'-'} | Braço: ${d.braco||'-'}`;
                });
            });
        }

        // Lê o formato salvo pelo painel do professor
        function carregarTreinoDoProfessor(dia) {
            const treinoContainer = document.getElementById('treino-dinamico-container');
            
            treinoContainer.innerHTML = `
                <h3 style="color:#ff9933;">${dia}</h3>
                <ul id="lista-treino-dinamico" style="list-style: none; padding: 0;">
                    <li class="exercicio-item" style="background: none; border: none; color: #ff9933;">
                        Carregando treino...
                    </li>
                </ul>
                <div style="margin-top:10px;">
                    <button class="btn-primary btn-finalizar-treino" onclick="finalizarTreino()">Finalizar Treino</button>
                </div>
            `;
            
            database.ref(getPath(`treinoModel/${dia}`)).on('value', snap => {
                const ul = document.getElementById('lista-treino-dinamico');
                ul.innerHTML = '';
                
                if (!snap.exists()) {
                    ul.innerHTML = `
                        <li class="exercicio-item" style="background: none; border: none; color: #ff9933;">
                            Treino não encontrado para ${dia}
                        </li>
                    `;
                    return;
                }

                const treinoRaw = snap.val();

                const exercicios = Array.isArray(treinoRaw)
                    ? treinoRaw
                    : (treinoRaw && Array.isArray(treinoRaw.exercicios) ? treinoRaw.exercicios : []);

                if (!exercicios || exercicios.length === 0) {
                    ul.innerHTML = `
                        <li class="exercicio-item" style="background: none; border: none; color: #ff9933;">
                            Nenhum exercício cadastrado para ${dia}
                        </li>
                    `;
                    return;
                }
                
                let contador = 0;
                exercicios.forEach(t => {
                    if (t && t.nome) {
                        contador++;
                        const id = `ex-${dia.replace(/\s/g, '')}-${contador}`;
                        const li = document.createElement('li');
                        li.className = 'exercicio-item';
                        li.setAttribute('data-exercicio', id);
                        li.innerHTML = `
                            <div class="exercicio-info">
                                <strong>${t.nome}</strong>
                                <span>${t.series || '--'}x | ${t.reps || '--'} reps</span>
                                ${t.nota ? `<br><small style="color:#ccc;">${t.nota}</small>` : ''}
                            </div>
                            <div class="checkbox-container">
                                <input type="checkbox" onchange="marcarConcluido(this, '${dia}', '${id}')">
                            </div>
                        `;
                        ul.appendChild(li);
                    }
                });
                
                carregarCheckboxes(dia);
            });
        }

        function marcarConcluido(chk, dia, id) {
            const li = chk.closest('li');
            if (chk.checked) {
                li.classList.add('concluido');
            } else {
                li.classList.remove('concluido');
            }
            database.ref(getPath(`treino_status/${dia}/${id}`)).set(chk.checked);
        }

        function carregarCheckboxes(dia) {
            database.ref(getPath(`treino_status/${dia}`)).once('value', snap => {
                const status = snap.val() || {};
                document.querySelectorAll(`#lista-treino-dinamico li`).forEach(li => {
                    const id = li.getAttribute('data-exercicio');
                    const chk = li.querySelector('input[type="checkbox"]');
                    if (chk && status[id]) {
                        chk.checked = true;
                        li.classList.add('concluido');
                    }
                });
            });
        }

        function gerarCalendario() {
            const hoje = new Date();
            const mesAtual = hoje.getMonth();
            const anoAtual = hoje.getFullYear();

            const primeiroDiaSemana = new Date(anoAtual, mesAtual, 1).getDay();
            const ultimoDiaMes = new Date(anoAtual, mesAtual + 1, 0).getDate();

            let html = '<tr>';
            let contadorDias = 1;
            for (let i = 0; i < 6; i++) {
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < primeiroDiaSemana) {
                        html += '<td></td>';
                    } else if (contadorDias > ultimoDiaMes) {
                        html += '<td></td>';
                    } else {
                        const chaveData = `${String(contadorDias).padStart(2,'0')}-${String(mesAtual+1).padStart(2,'0')}-${anoAtual}`;
                        html += `<td id="dia-${chaveData}" onclick="togglePresenca('${chaveData}')">${contadorDias}</td>`;
                        contadorDias++;
                    }
                }
                html += '</tr>';
                if (contadorDias > ultimoDiaMes) break;
            }
            document.getElementById('calendario-body').innerHTML = html;
            carregarPresencas();
        }

        function togglePresenca(key) {
            const td = document.getElementById(`dia-${key}`);
            const status = td.classList.contains('presente');
            if (status) {
                database.ref(getPath(`presenca/${key}`)).remove();
                td.classList.remove('presente');
            } else {
                database.ref(getPath(`presenca/${key}`)).set(true);
                td.classList.add('presente');
            }
        }

        function carregarPresencas() {
            database.ref(getPath('presenca')).on('value', snap => {
                const p = snap.val() || {};
                document.querySelectorAll('#calendario-body td').forEach(td => td.classList.remove('presente'));
                Object.keys(p).forEach(k => {
                    const td = document.getElementById(`dia-${k}`);
                    if (td) td.classList.add('presente');
                });
            });
        }

        async function simularPesquisaIA() {
            const pergunta = document.getElementById('exercicioPergunta').value.trim().toLowerCase();
            const perguntaNormalizada = normalize(pergunta);
            const respostaDiv = document.getElementById('ai-resposta');
            const botao = document.querySelector('#ai-search-card .btn-primary');
            
            if (pergunta.length < 3) {
                respostaDiv.innerHTML = '<strong style="color: #dc3545;">Por favor, digite uma pergunta mais completa.</strong>';
                return;
            }

            botao.disabled = true;
            botao.textContent = 'Pesquisando no Banco de Dados...';
            respostaDiv.innerHTML = '<p style="text-align: center; color: #666;">Consultando informações...</p>';
            
            await new Promise(resolve => setTimeout(resolve, 800));
            
            let respostaTexto = '';
            let exercicioEncontrado = null;

            const palavrasDaPergunta = perguntaNormalizada.split(' ').filter(p => p.length > 2);
            let maxPontos = 0;

            for (const key in bancoDeExercicios) {
                const ex = bancoDeExercicios[key];
                let pontos = 0;

                if (perguntaNormalizada.includes(normalize(ex.nome))) {
                    pontos += 100;
                }

                palavrasDaPergunta.forEach(palavra => {
                    if (ex.termos.includes(palavra)) {
                        pontos += 1;
                    }
                });

                if (pontos > 0 && pontos > maxPontos) {
                    maxPontos = pontos;
                    exercicioEncontrado = ex;
                }
            }

            if (exercicioEncontrado) {
                const nomeEx = exercicioEncontrado.nome;
                if (perguntaNormalizada.includes("músculos") || perguntaNormalizada.includes("musculos") || perguntaNormalizada.includes("trabalha") || perguntaNormalizada.includes("ativa")) {
                    respostaTexto = `**Músculos Principais de ${nomeEx}:** ${exercicioEncontrado.musculos}`;
                } else if (perguntaNormalizada.includes("execução") || perguntaNormalizada.includes("forma correta") || perguntaNormalizada.includes("fazer") || perguntaNormalizada.includes("tecnica")) {
                    respostaTexto = `**Execução do ${nomeEx}:** ${exercicioEncontrado.execucao}\n\n**Dica Importante:** ${exercicioEncontrado.dica}`;
                } else if (perguntaNormalizada.includes("dica") || perguntaNormalizada.includes("segurança")) {
                    respostaTexto = `**Dica de Segurança para ${nomeEx}:** ${exercicioEncontrado.dica}`;
                }
                else {
                    respostaTexto = `**Informações sobre ${nomeEx}**\n\n**Músculos:** ${exercicioEncontrado.musculos}\n\n**Execução:** ${exercicioEncontrado.execucao}\n\n**Dica Importante:** ${exercicioEncontrado.dica}`;
                }

            } else {
                respostaTexto = `Desculpe, não encontrei informações detalhadas sobre a sua pergunta ("${pergunta}").`;
            }

            let respostaFormatada = respostaTexto
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');

            respostaDiv.innerHTML = `<div style="text-align: left; padding: 10px;">${respostaFormatada}</div>`;
            
            botao.disabled = false;
            botao.textContent = 'Perguntar à IA';
        }

        function resetarDados(tipo) {
            let path;
            let msg;

            switch (tipo) {
                case 'presenca':
                    path = 'presenca';
                    msg = 'histórico de presenças';
                    break;
                case 'cargas':
                    path = `cargas/${document.getElementById('seletorExercicio').value}`;
                    msg = 'histórico de cargas para este exercício';
                    break;
                case 'medidas':
                    path = 'medidas';
                    msg = 'histórico de medidas corporais';
                    break;
                case 'treinos':
                    path = 'treinosFinalizados';
                    msg = 'histórico completo de treinos';
                    break;
                default:
                    return;
            }

            if (confirm(`Tem certeza que deseja apagar o ${msg}? Isso não pode ser desfeito.`)) {
                database.ref(getPath(path)).remove()
                    .then(() => {
                        alert('Histórico apagado com sucesso!');
                        if (tipo === 'presenca') gerarCalendario();
                        if (tipo === 'cargas') inicializarGrafico();
                        if (tipo === 'medidas') document.getElementById('ultimasMedidas').innerHTML = 'Nenhum registro encontrado.';
                        if (tipo === 'treinos') {
                            carregarUltimoTreino();
                            contarTreinosDoMes();
                            carregarTreinosFinalizados();
                        }
                    })
                    .catch(error => {
                        console.error("Erro ao resetar dados:", error);
                        alert("Erro ao apagar dados.");
                    });
            }
        }
    </script>
</body>
</html>
